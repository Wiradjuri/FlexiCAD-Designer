<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Generator - FlexiCAD Designer</title>
  
  <!-- Dark Theme Styles -->
  <link rel="stylesheet" href="css/dark-theme.css">
  
  <!-- Theme Management -->
  <script src="js/theme.js"></script>
  
  <script src="config/config.js"></script>
  
  <style>
    .generator-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .control-panel {
      margin-bottom: 24px;
    }
    
    .control-panel textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .result-section {
      margin-top: 32px;
    }
    
    .code-container {
      position: relative;
    }
    
    .code-output {
      background: var(--bg-primary);
      border: 1px solid var(--border-input);
      border-radius: 12px;
      padding: 20px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 200px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .section-header {
      margin-bottom: 16px;
    }
    
    .hidden {
      display: none;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="generator-container">
    <nav class="nav">
      <div><a href="index.html"><strong>FlexiCAD Designer</strong></a> / AI Generator</div>
      <div class="nav-right">
        <a href="home.html">Home</a> 
        <a href="templates.html">Templates</a>
        <button onclick="toggleTheme()" class="theme-toggle">
          <span class="theme-toggle-icon" id="themeIcon">ðŸŒ™</span>
          <span id="themeText">Dark</span>
        </button>
      </div>
    </nav>

    <section class="hero">
      <h1>AI Code Generator</h1>
      <p class="text-secondary">Describe your design and let AI generate OpenSCAD code for you</p>
    </section>

    <div class="card control-panel">
      <h3 class="section-header">Design Prompt</h3>
      <textarea 
        id="prompt" 
        placeholder="Describe your design... For example: 'Create a phone stand with adjustable angle, 10cm wide and 8cm deep'"
        rows="4"
      ></textarea>
      
      <div class="button-group">
        <button onclick="generate()" class="btn-primary">
          <span id="generateText">Generate Design</span>
          <div id="generateSpinner" class="spinner hidden"></div>
        </button>
      </div>
    </div>

    <div class="result-section">
      <div class="card">
        <div class="result-header">
          <h3>Generated Code</h3>
          <div class="button-group">
            <button onclick="copyCode()" class="btn-secondary btn-small">Copy Code</button>
            <button onclick="download()" class="btn-secondary btn-small">Download .scad</button>
          </div>
        </div>
        
        <div class="code-container">
          <pre id="code" class="code-output">Generated code will appear here...</pre>
        </div>
      </div>
    </div>
  </div>

<script>
async function generate(){
  const prompt = document.getElementById('prompt').value.trim();
  if(!prompt) {
    alert('Please enter a design description');
    return;
  }
  
  // Show loading state
  const generateText = document.getElementById('generateText');
  const generateSpinner = document.getElementById('generateSpinner');
  const button = generateText.parentElement;
  
  generateText.textContent = 'Generating...';
  generateSpinner.classList.remove('hidden');
  button.disabled = true;
  
  try {
    const res = await fetch('/api/generate-template',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({prompt})
    });
    const data = await res.json();
    
    if (data.error) {
      document.getElementById('code').textContent = `Error: ${data.error}`;
      document.getElementById('code').style.color = 'var(--error)';
    } else {
      document.getElementById('code').textContent = data.code || 'No code generated';
      document.getElementById('code').style.color = 'var(--text-primary)';
    }
  } catch (error) {
    document.getElementById('code').textContent = `Network Error: ${error.message}`;
    document.getElementById('code').style.color = 'var(--error)';
  } finally {
    // Reset loading state
    generateText.textContent = 'Generate Design';
    generateSpinner.classList.add('hidden');
    button.disabled = false;
  }
}

async function copyCode(){
  const code = document.getElementById('code').textContent;
  if (code === 'Generated code will appear here...') {
    alert('No code to copy yet');
    return;
  }
  
  try {
    await navigator.clipboard.writeText(code);
    
    // Show success feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.style.background = 'var(--success)';
    
    setTimeout(() => {
      button.textContent = originalText;
      button.style.background = '';
    }, 2000);
  } catch (err) {
    alert('Failed to copy to clipboard');
  }
}

function download(){
  const code = document.getElementById('code').textContent;
  if (code === 'Generated code will appear here...') {
    alert('No code to download yet');
    return;
  }
  
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([code],{type:'text/plain'}));
  a.download = 'flexicad-design.scad';
  a.click();
}

// Allow Enter key to trigger generation
document.getElementById('prompt').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    generate();
  }
});
</script>
</body>
</html>
