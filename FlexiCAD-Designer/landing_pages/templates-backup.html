<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlexiCAD Designer - Templates</title>
  <link rel="icon" href="favicon.ico" />

  <!-- Config must load before JS -->
  <script src="config/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary-blue: #1e40af;
      --secondary-blue: #3b82f6;
      --dark-gray: #1f2937;
      --light-gray: #f9fafb;
      --border-gray: #e5e7eb;
      --text-gray: #6b7280;
      --error-red: #ef4444;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--light-gray);
      color: var(--dark-gray);
    }
    header {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .logo { font-weight: bold; font-size: 1.25rem; color: var(--primary-blue); }
    .nav-links { display: flex; list-style: none; gap: 1.5rem; }
    .nav-links a { text-decoration: none; color: var(--text-gray); font-weight: 500; }
    .nav-links a.active, .nav-links a:hover { color: var(--primary-blue); }
    .user-menu { display: flex; align-items: center; gap: 1rem; }
    .btn-logout { border: 1px solid var(--border-gray); background: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; }
    .btn-logout:hover { border-color: var(--primary-blue); color: var(--primary-blue); }
    main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .page-header { text-align: center; margin-bottom: 2rem; }
    .page-header h1 { margin-bottom: 0.5rem; font-size: 2rem; }
    .filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .template-card { background: white; border: 1px solid var(--border-gray); border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .template-title { margin: 0 0 0.5rem; font-size: 1.2rem; color: var(--primary-blue); }
    .template-category { font-size: 0.8rem; color: var(--text-gray); margin-bottom: 0.5rem; display: inline-block; }
    .template-description { font-size: 0.9rem; margin-bottom: 1rem; }
    .template-actions { display: flex; gap: 0.5rem; }
    .btn { padding: 0.4rem 0.8rem; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; }
    .btn-primary { background: var(--primary-blue); color: white; }
    .btn-secondary { background: white; border: 1px solid var(--primary-blue); color: var(--primary-blue); }
    .btn:hover { opacity: 0.9; }
    .loading, .error { text-align: center; margin: 2rem 0; }
    .error { color: var(--error-red); }
    /* Modal */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
    .modal.active { display: flex; }
    .modal-content { background:white; border-radius:8px; max-width:800px; width:90%; max-height:90vh; display:flex; flex-direction:column; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid var(--border-gray); }
    .modal-body { padding:1rem; overflow:auto; background:#f9fafb; font-family:monospace; font-size:0.85rem; }
    .modal-footer { padding:1rem; border-top:1px solid var(--border-gray); display:flex; gap:0.5rem; justify-content:flex-end; }
    .modal-close { cursor:pointer; font-size:1.25rem; border:none; background:none; }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">FlexiCAD Designer</div>
      <ul class="nav-links">
        <li><a href="home.html">Home</a></li>
        <li><a href="templates.html" class="active">Templates</a></li>
        <li><a href="ai.html">AI Generator</a></li>
        <li><a href="my-designs.html">My Designs</a></li>
      </ul>
      <div class="user-menu">
        <span id="user-email">Loading...</span>
        <button class="btn-logout" id="logout-btn">Logout</button>
      </div>
    </nav>
  </header>

  <main>
    <section class="page-header">
      <h1>Design Templates</h1>
      <p>Explore pre-built OpenSCAD templates to jumpstart your projects.</p>
    </section>

    <div class="filters">
      <select id="category-filter"><option value="">All Categories</option></select>
      <input type="text" id="search-input" placeholder="Search templates..." />
      <button class="btn btn-secondary" id="refresh-btn">Refresh</button>
    </div>

    <div id="error-container"></div>
    <div id="loading" class="loading">Loading templates...</div>
    <div id="templates-grid" class="templates-grid" style="display:none;"></div>
  </main>

  <!-- Code Modal -->
  <div id="code-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Template Code</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="code-content"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="copy-code-btn">Copy</button>
        <button class="btn btn-primary" id="download-code-btn">Download .scad</button>
      </div>
    </div>
  </div>

  <script>
    class FlexiCADTemplates {
      constructor() {
        this.templates = [];
        this.filteredTemplates = [];
        this.currentTemplate = null;
        this.init();
      }
      init() {
        this.setupEvents();
        this.loadTemplates();
      }
      async loadTemplates() {
        try {
          const res = await fetch("objects/manifest.json");
          if (!res.ok) throw new Error(res.statusText);
          const manifest = await res.json();
          this.templates = manifest.templates;
          this.filteredTemplates = [...this.templates];
          this.populateCategories();
          this.renderTemplates();
          document.getElementById("loading").style.display = "none";
        } catch (e) {
          this.showError("Failed to load templates. Please try again later.");
        }
      }
      populateCategories() {
        const sel = document.getElementById("category-filter");
        [...new Set(this.templates.map(t => t.category))].forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          sel.appendChild(opt);
        });
      }
      renderTemplates() {
        const grid = document.getElementById("templates-grid");
        grid.style.display = "grid";
        grid.innerHTML = this.filteredTemplates.map(t => `
          <div class="template-card">
            <h3 class="template-title">${t.name}</h3>
            <div class="template-category">${t.category||""}</div>
            <p class="template-description">${t.description||""}</p>
            <div class="template-actions">
              <button class="btn btn-primary" onclick="templatesInstance.viewTemplate('${t.id}')">View Code</button>
              <button class="btn btn-secondary" onclick="templatesInstance.downloadTemplate('${t.id}')">Download</button>
            </div>
          </div>
        `).join("");
      }
      async viewTemplate(id) {
        try {
          const res = await fetch(`objects/${id}/template.scad`);
          if (!res.ok) throw new Error(res.statusText);
          const code = await res.text();
          this.currentTemplate = {id, code};
          document.getElementById("modal-title").textContent = id;
          document.getElementById("code-content").textContent = code;
          document.getElementById("code-modal").classList.add("active");
        } catch (e) {
          document.getElementById("code-content").textContent = "Failed to load code.";
          document.getElementById("code-modal").classList.add("active");
        }
      }
      downloadTemplate(id) {
        fetch(`objects/${id}/template.scad`).then(r=>r.text()).then(code=>{
          const a = document.createElement("a");
          a.href = URL.createObjectURL(new Blob([code], {type:"text/plain"}));
          a.download = `${id}.scad`; a.click();
        });
      }
      filterTemplates() {
        const cat = document.getElementById("category-filter").value;
        const q = document.getElementById("search-input").value.toLowerCase();
        this.filteredTemplates = this.templates.filter(t =>
          (!cat || t.category===cat) &&
          (!q || t.name.toLowerCase().includes(q) || t.description.toLowerCase().includes(q))
        );
        this.renderTemplates();
      }
      setupEvents() {
        document.getElementById("category-filter").onchange = ()=>this.filterTemplates();
        document.getElementById("search-input").oninput = ()=>this.filterTemplates();
        document.getElementById("refresh-btn").onclick = ()=>this.loadTemplates();
        document.getElementById("modal-close").onclick = ()=>document.getElementById("code-modal").classList.remove("active");
        document.getElementById("copy-code-btn").onclick = ()=>navigator.clipboard.writeText(this.currentTemplate?.code||"");
        document.getElementById("download-code-btn").onclick = ()=>this.downloadTemplate(this.currentTemplate?.id);
      }
      showError(msg){document.getElementById("error-container").innerHTML=`<div class="error">${msg}</div>`;}
    }
    let templatesInstance;
    document.addEventListener("DOMContentLoaded", ()=>templatesInstance=new FlexiCADTemplates());
  </script>
</body>
</html>
