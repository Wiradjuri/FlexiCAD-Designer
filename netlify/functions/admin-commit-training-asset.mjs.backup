import { createClient } from '@supabase/supabase-js';
import { requireAdmin, corsHeaders, json } from '../lib/require-admin.mjs';

// Admin endpoint to commit training asset metadata after successful upload - Enhanced JSONL validation
export const handler = async (event, context) => {
    console.log('üöÄ [admin-commit-training-asset] Request received:', {
        method: event.httpMethod,
        path: event.path
    });

    if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers: corsHeaders, body: '' };
    }

    if (event.httpMethod !== 'POST') {
        return json(405, { ok: false, code: 'method_not_allowed', error: 'Method not allowed' });
    }

    // Check admin access using robust helper
    const gate = await requireAdmin(event);
    if (!gate.ok) {
        return json(gate.status, { ok: false, code: gate.code, error: gate.error });
    }
    
    const requesterEmail = gate.requesterEmail;
    const supabase = gate.supabase; // service client

    try {

        // Parse request body
        const body = JSON.parse(event.body || '{}');
        let { object_path, assetType, filename, size, contentType, tags } = body;

        // Validate input
        if (!object_path || !filename) {
            return json(400, { 
                ok: false,
                code: 'missing_fields',
                error: 'Missing required fields: object_path, filename' 
            });
        }

        // Derive assetType from object_path if not provided
        if (!assetType) {
            const ext = object_path.toLowerCase().split('.').pop();
            if (['svg', 'scad', 'jsonl'].includes(ext)) {
                assetType = ext;
            } else {
                return json(400, { 
                    ok: false,
                    code: 'invalid_file_type',
                    error: 'File must be .svg, .scad, or .jsonl' 
                });
            }
        }

        // Normalize tags
        if (!Array.isArray(tags)) {
            tags = [];
        }

        console.log(`[admin][commit-asset] requester=${requesterEmail} path=${object_path} type=${assetType}`);

        // JSONL validation for JSONL files
        let sampleValidated = false;
        let sampleCount = 0;
        
        if (assetType === 'jsonl') {
            try {
                console.log('üîç [admin-commit-training-asset] Validating JSONL file...');
                
                // Read first ‚â§ 64KB from Storage object for performance
                const maxValidationSize = 64 * 1024; // 64KB limit
                const bucketName = process.env.SUPABASE_STORAGE_BUCKET_TRAINING || 'training-assets';
                
                const { data: fileData, error: downloadError } = await supabase.storage
                    .from(bucketName)
                    .download(object_path);

                if (downloadError) {
                    console.warn('‚ö†Ô∏è [admin-commit-training-asset] Could not download file for validation:', downloadError);
                    return json(400, { 
                        ok: false,
                        code: 'file_not_accessible',
                        error: 'Could not access uploaded file for validation',
                        details: downloadError.message
                    });
                }

                if (fileData) {
                    // Read file content as text
                    let content = await fileData.text();
                    
                    // Strip UTF-8 BOM if present
                    if (content.charCodeAt(0) === 0xFEFF) {
                        content = content.substring(1);
                        console.log('üßπ [admin-commit-training-asset] Stripped UTF-8 BOM from file');
                    }
                    
                    // Limit content size for validation performance
                    if (content.length > maxValidationSize) {
                        content = content.substring(0, maxValidationSize);
                        console.log(`üìè [admin-commit-training-asset] Validating first ${maxValidationSize} bytes of JSONL file`);
                    }
                    
                    // Split by CRLF or LF, skip blanks and comments
                    const lines = content
                        .split(/\r\n|\n/)
                        .map((line, index) => ({ line: line.trim(), number: index + 1 }))
                        .filter(({ line }) => line.length > 0 && !line.startsWith('#'));
                    
                    console.log(`üìã [admin-commit-training-asset] Found ${lines.length} non-empty lines to validate`);
                    
                    // Validate first N=20 non-blank lines for performance
                    const maxLinesToValidate = Math.min(20, lines.length);
                    let validatedCount = 0;
                    
                    for (let i = 0; i < maxLinesToValidate; i++) {
                        const { line, number } = lines[i];
                        
                        try {
                            const parsed = JSON.parse(line);
                            validatedCount++;
                            
                            // Check if parsed result is an object
                            if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                                validationResult.errors.push(`Line ${number}: Expected JSON object, got ${Array.isArray(parsed) ? 'array' : typeof parsed}`);
                                validationResult.valid = false;
                            } else {
                                // Check for recommended training data fields
                                const recommendedKeys = ['input_prompt', 'generated_code'];
                                const missingKeys = recommendedKeys.filter(key => !(key in parsed));
                                
                                if (missingKeys.length > 0) {
                                    validationResult.errors.push(`Line ${number}: Missing recommended keys: ${missingKeys.join(', ')}`);
                                    validationResult.valid = false;
                                }
                            }
                            
                        } catch (jsonError) {
                            const errorSnippet = line.length > 50 ? line.substring(0, 47) + '...' : line;
                            validationResult.errors.push(`Line ${number}: Invalid JSON - ${jsonError.message} | ${errorSnippet}`);
                            validationResult.valid = false;
                            
                            // Stop validation after first few errors to avoid spam
                            if (validationResult.errors.length >= 5) {
                                validationResult.errors.push('... (stopping validation after 5 errors)');
                                break;
                            }
                        }
                    }
                    
                    validationResult.sampleValidated = true;
                    validationResult.sampleCount = validatedCount;
                    
                    console.log(`‚úÖ [admin-commit-training-asset] JSONL validation complete: ${validatedCount} lines checked, ${validationResult.errors.length} errors`);
                }
            } catch (validationError) {
                console.error('‚ùå [admin-commit-training-asset] JSONL validation error:', validationError);
                validationResult.errors.push(`Validation failed: ${validationError.message}`);
                validationResult.valid = false;
            }
        }

        // If JSONL validation failed, return error with precise details
        if (assetType === 'jsonl' && !validationResult.valid) {
            return json(400, { 
                ok: false,
                code: 'invalid_jsonl',
                error: 'Invalid JSONL file',
                lineNumber: validationResult.errors[0]?.match(/Line (\d+):/)?.[1] || null,
                snippet: validationResult.errors[0]?.split(' | ')[1] || null,
                validation_errors: validationResult.errors,
                help: 'Each line must be valid JSON object with input_prompt and generated_code fields'
            });
        }

        // Upsert metadata into training_assets table (idempotent on object_path)
        const assetData = {
            object_path,
            asset_type: assetType,
            filename,
            content_type: contentType || 'application/octet-stream',
            size_bytes: parseInt(size, 10) || 0,
            tags: tags || [],
            created_by: gate.requesterId,
            active: true,
            updated_at: new Date().toISOString()
        };

        const { data: insertedAsset, error: insertError } = await supabase
            .from('training_assets')
            .upsert([assetData], {
                onConflict: 'object_path',
                ignoreDuplicates: false
            })
            .select()
            .single();

        if (insertError) {
            console.error('‚ùå [admin-commit-training-asset] Failed to upsert asset:', insertError);
            return json(500, { 
                ok: false,
                code: 'database_error',
                error: 'Failed to commit training asset metadata',
                details: insertError.message
            });
        }

        // Log to admin audit (don't fail request if this fails)
        try {
            await supabase
                .from('admin_audit')
                .insert([{
                    admin_email: requesterEmail,
                    action: 'training_asset_commit',
                    resource_type: 'training_asset',
                    resource_id: insertedAsset.id,
                    details: {
                        object_path,
                        filename,
                        assetType,
                        size,
                        tags: tags || [],
                        validation: validationResult
                    }
                }]);
        } catch (auditError) {
            console.warn('‚ö†Ô∏è [admin-commit-training-asset] Failed to log admin audit:', auditError.message);
        }

        console.log(`‚úÖ [admin-commit-training-asset] Successfully committed: ${filename} (${assetType}) ‚Üí ${insertedAsset.id}`);

        return json(200, {
            ok: true,
            id: insertedAsset.id,
            object_path,
            sampleValidated: assetType === 'jsonl',
            sampleCount
        });

    } catch (error) {
        console.error('üî• [admin-commit-training-asset] Unexpected error:', error);
        return json(500, { 
            ok: false,
            code: 'internal_error',
            error: error.message 
        });
    }
};