<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promo Code Management - FlexiCAD Designer</title>
    <link rel="stylesheet" href="css/dark-theme.css">
    <style>
        .promo-management {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .management-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .form-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .table-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .promo-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .promo-table th,
        .promo-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .promo-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .promo-table tr:hover {
            background: var(--bg-secondary);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-inactive {
            background: #ef4444;
            color: white;
        }

        .status-expired {
            background: #f59e0b;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-toggle {
            background: var(--primary-color);
            color: white;
        }

        .btn-toggle:hover {
            background: var(--primary-hover);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .admin-only {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body pre {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .promo-table {
                font-size: 0.8rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">FlexiCAD Designer - Admin</div>
            <ul class="nav-menu">
                <li><a href="ai.html" class="nav-link">Back to App</a></li>
                <li><button onclick="logout()" class="nav-link btn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <main class="promo-management">
        <div class="management-header">
            <h1 class="page-title">Promo Code Management</h1>
            <p class="page-subtitle">Create and manage discount codes for FlexiCAD Designer subscriptions</p>
        </div>

        <div id="auth-check" class="admin-only">
            üîê Checking admin permissions...
        </div>

        <div id="admin-content" style="display: none;">
            <!-- Add New Promo Code Form -->
            <div class="form-section">
                <h2>Create New Promo Code</h2>
                <div id="form-messages"></div>

                <form id="promo-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="code">Promo Code *</label>
                            <input type="text" id="code" name="code" required
                                   placeholder="e.g., WELCOME20"
                                   style="text-transform: uppercase;"
                                   pattern="[A-Z0-9]+"
                                   title="Only uppercase letters and numbers allowed">
                        </div>

                        <div class="form-group">
                            <label for="discount">Discount % *</label>
                            <input type="number" id="discount" name="discount"
                                   min="1" max="100" required
                                   placeholder="e.g., 20">
                        </div>

                        <div class="form-group form-group-full">
                            <label for="description">Description</label>
                            <input type="text" id="description" name="description"
                                   placeholder="e.g., 20% off for new customers">
                        </div>

                        <div class="form-group">
                            <label for="expires-at">Expiry Date (Optional)</label>
                            <input type="datetime-local" id="expires-at" name="expires_at">
                        </div>

                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn btn-primary">Create Promo Code</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Promo Codes Table -->
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Existing Promo Codes</h2>
                    <button onclick="loadPromoCodes()" class="btn btn-secondary">üîÑ Refresh</button>
                </div>

                <div id="table-loading" class="loading">Loading promo codes...</div>
                <div id="table-error" style="display: none;"></div>

                <table class="promo-table" id="promo-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                            <th>Discount</th>
                            <th>Status</th>
                            <th>Expires</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="promo-table-body">
                        <!-- Promo codes will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- User Feedback Management -->
            <div class="table-section" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>User Feedback Review</h2>
                    <button onclick="loadFeedback()" class="btn btn-secondary">üîÑ Refresh</button>
                </div>

                <div id="feedback-loading" class="loading" style="display: none;">Loading user feedback...</div>
                <div id="feedback-error" style="display: none;"></div>

                <table class="promo-table" id="feedback-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Template</th>
                            <th>Quality Score</th>
                            <th>Feedback</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-table-body">
                        <!-- Feedback will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Training Assets Management -->
            <div class="table-section" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Training Assets</h2>
                    <button onclick="loadTrainingAssets()" class="btn btn-secondary">üîÑ Refresh</button>
                </div>

                <div id="assets-loading" class="loading" style="display: none;">Loading training assets...</div>
                <div id="assets-error" style="display: none;"></div>

                <table class="promo-table" id="assets-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>File Size</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assets-table-body">
                        <!-- Training assets will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/secure-config-loader.js"></script>
    <script src="js/flexicad-auth.js"></script>
    <script>
        // Promo Code Management System
        let supabaseAdmin = null;

        // Initialize admin Supabase client with service role
        function initializeAdminSupabase() {
            // Use the shared Supabase client from flexicadAuth
            supabaseAdmin = window.flexicadAuth.getSupabaseClient();
            if (!supabaseAdmin) {
                console.error('Failed to get shared Supabase client');
                return null;
            }
            return supabaseAdmin;
        }

        // Check if user is admin and authenticated
        async function checkAdminAccess() {
            console.log('üîê Checking admin access...');

            try {
                // Initialize auth system
                await window.flexicadAuth.init();

                console.log('‚úÖ Auth initialized');
                console.log('User:', window.flexicadAuth.user);
                console.log('Payment Status:', window.flexicadAuth.paymentStatus);

                // Check if user is logged in
                if (!window.flexicadAuth.user) {
                    console.log('‚ùå User not logged in');
                    showMessage('error', 'Admin access required. Please log in first.');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }

                console.log('‚úÖ User is logged in:', window.flexicadAuth.user.email);

                // Check if user is paid (basic requirement)
                if (!window.flexicadAuth.paymentStatus?.hasPaid) {
                    console.log('‚ùå User payment not verified:', window.flexicadAuth.paymentStatus);
                    showMessage('error', 'Admin access denied. Account must have valid payment.');
                    return false;
                }

                console.log('‚úÖ User has valid payment');

                // Check admin status from database
                const isAdminUser = await window.flexicadAuth.checkAdminAccess();
                console.log('‚úÖ Admin check result:', isAdminUser);

                if (!isAdminUser) {
                    console.log('‚ùå User is not admin');
                    showMessage('error', 'Admin access denied. This feature is restricted to administrators only.');
                    setTimeout(() => {
                        window.location.href = '/ai.html';
                    }, 3000);
                    return false;
                }

                console.log('‚úÖ Admin access granted');
                document.getElementById('auth-check').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';

                // Initialize admin client
                initializeAdminSupabase();

                // Load initial data
                await loadPromoCodes();
                await loadFeedback();
                await loadTrainingAssets();

                return true;
            } catch (error) {
                console.error('‚ùå Admin access check failed:', error);
                showMessage('error', 'Failed to verify admin access: ' + error.message);
                return false;
            }
        }

        // Show success/error messages
        function showMessage(type, message) {
            const container = document.getElementById('form-messages');
            const className = type === 'error' ? 'error-message' : 'success-message';
            container.innerHTML = `<div class="${className}">${message}</div>`;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Create new promo code
        async function createPromoCode(formData) {
            console.log('üéüÔ∏è Creating promo code:', formData.code);

            try {
                const promoData = {
                    code: formData.code.toUpperCase(),
                    description: formData.description || null,
                    discount_percent: parseInt(formData.discount),
                    expires_at: formData.expires_at || null
                };

                const { data, error } = await supabaseAdmin
                    .from('promo_codes')
                    .insert([promoData])
                    .select()
                    .single();

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Promo code created successfully:', data);
                showMessage('success', `Promo code "${formData.code}" created successfully!`);

                // Reset form and reload table
                document.getElementById('promo-form').reset();
                await loadPromoCodes();

            } catch (error) {
                console.error('‚ùå Failed to create promo code:', error);

                if (error.code === '23505') { // Unique constraint violation
                    showMessage('error', 'Promo code already exists. Please choose a different code.');
                } else {
                    showMessage('error', 'Failed to create promo code: ' + error.message);
                }
            }
        }

        // Load all promo codes
        async function loadPromoCodes() {
            console.log('üìã Loading promo codes...');

            const loading = document.getElementById('table-loading');
            const table = document.getElementById('promo-table');
            const errorDiv = document.getElementById('table-error');

            loading.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const { data: promoCodes, error } = await supabaseAdmin
                    .from('promo_codes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Loaded promo codes:', promoCodes.length);

                // Populate table
                const tbody = document.getElementById('promo-table-body');
                tbody.innerHTML = '';

                if (promoCodes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No promo codes found. Create your first one above!</td></tr>';
                } else {
                    promoCodes.forEach(promo => {
                        tbody.appendChild(createPromoRow(promo));
                    });
                }

                loading.style.display = 'none';
                table.style.display = 'table';

            } catch (error) {
                console.error('‚ùå Failed to load promo codes:', error);
                loading.style.display = 'none';
                errorDiv.innerHTML = `<div class="error-message">Failed to load promo codes: ${error.message}</div>`;
                errorDiv.style.display = 'block';
            }
        }

        // Create table row for promo code
        function createPromoRow(promo) {
            const row = document.createElement('tr');

            // Determine status
            const now = new Date();
            const expiresAt = promo.expires_at ? new Date(promo.expires_at) : null;

            let status, statusClass;
            if (!promo.active) {
                status = 'Inactive';
                statusClass = 'status-inactive';
            } else if (expiresAt && expiresAt <= now) {
                status = 'Expired';
                statusClass = 'status-expired';
            } else {
                status = 'Active';
                statusClass = 'status-active';
            }

            row.innerHTML = `
                <td><strong>${promo.code}</strong></td>
                <td>${promo.description || '‚Äî'}</td>
                <td>${promo.discount_percent}%</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>${expiresAt ? new Date(promo.expires_at).toLocaleDateString() : 'Never'}</td>
                <td>${new Date(promo.created_at).toLocaleDateString()}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-small btn-toggle" onclick="togglePromoCode('${promo.code}', ${promo.active})">
                            ${promo.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn-small btn-delete" onclick="deletePromoCode('${promo.code}')">
                            Delete
                        </button>
                    </div>
                </td>
            `;

            return row;
        }

        // Toggle promo code active status
        async function togglePromoCode(code, currentStatus) {
            console.log('üîÑ Toggling promo code:', code, 'from', currentStatus, 'to', !currentStatus);

            try {
                const { error } = await supabaseAdmin
                    .from('promo_codes')
                    .update({ active: !currentStatus })
                    .eq('code', code);

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Promo code toggled successfully');
                showMessage('success', `Promo code "${code}" ${!currentStatus ? 'activated' : 'deactivated'} successfully!`);
                await loadPromoCodes();

            } catch (error) {
                console.error('‚ùå Failed to toggle promo code:', error);
                showMessage('error', 'Failed to update promo code: ' + error.message);
            }
        }

        // Delete promo code
        async function deletePromoCode(code) {
            if (!confirm(`Are you sure you want to delete promo code "${code}"? This action cannot be undone.`)) {
                return;
            }

            console.log('üóëÔ∏è Deleting promo code:', code);

            try {
                const { error } = await supabaseAdmin
                    .from('promo_codes')
                    .delete()
                    .eq('code', code);

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Promo code deleted successfully');
                showMessage('success', `Promo code "${code}" deleted successfully!`);
                await loadPromoCodes();

            } catch (error) {
                console.error('‚ùå Failed to delete promo code:', error);
                showMessage('error', 'Failed to delete promo code: ' + error.message);
            }
        }

        // Load user feedback for review
        async function loadFeedback() {
            console.log('üìù Loading user feedback...');

            const loading = document.getElementById('feedback-loading');
            const table = document.getElementById('feedback-table');
            const errorDiv = document.getElementById('feedback-error');

            loading.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/admin-feedback-list', {
                    headers: {
                        'Authorization': `Bearer ${window.flexicadAuth.getToken()}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Loaded feedback:', result);

                // Populate table
                const tbody = document.getElementById('feedback-table-body');
                tbody.innerHTML = '';

                if (!result.items || result.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No user feedback found.</td></tr>';
                } else {
                    result.items.forEach(feedback => {
                        tbody.appendChild(createFeedbackRow(feedback));
                    });
                }

                loading.style.display = 'none';
                table.style.display = 'table';

            } catch (error) {
                console.error('‚ùå Failed to load feedback:', error);
                loading.style.display = 'none';
                errorDiv.innerHTML = `<div class="error-message">Failed to load feedback: ${error.message}</div>`;
                errorDiv.style.display = 'block';
            }
        }

        // Create table row for feedback
        function createFeedbackRow(feedback) {
            const row = document.createElement('tr');

            // Status styling
            let statusClass = '';
            switch (feedback.review_status) {
                case 'pending':
                    statusClass = 'status-inactive';
                    break;
                case 'accepted':
                    statusClass = 'status-active';
                    break;
                case 'rejected':
                    statusClass = 'status-expired';
                    break;
            }

            const feedbackText = feedback.feedback_text ? 
                (feedback.feedback_text.length > 50 ? 
                    feedback.feedback_text.substring(0, 50) + '...' : 
                    feedback.feedback_text) : 
                '‚Äî';

            const actions = feedback.review_status === 'pending' ? 
                `<button class="btn-small btn-success" onclick="decideFeedback('${feedback.id}', 'accept_and_train')">Accept & Train</button>
                 <button class="btn-small btn-delete" onclick="decideFeedback('${feedback.id}', 'reject')">Reject</button>` :
                `<em>Reviewed by ${feedback.reviewed_by || 'Unknown'}</em>`;

            row.innerHTML = `
                <td>${feedback.user_email || 'Unknown'}</td>
                <td>${feedback.template || '‚Äî'}</td>
                <td>${feedback.quality_score || '‚Äî'}/5</td>
                <td title="${feedback.feedback_text || ''}">${feedbackText}</td>
                <td><span class="status-badge ${statusClass}">${feedback.review_status || 'pending'}</span></td>
                <td>${new Date(feedback.created_at).toLocaleDateString()}</td>
                <td>${actions}</td>
            `;

            return row;
        }

        // Decide on feedback (accept or reject)
        async function decideFeedback(feedbackId, decision) {
            console.log('‚öñÔ∏è Deciding on feedback:', feedbackId, decision);

            try {
                const response = await fetch('/api/admin-feedback-decide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.flexicadAuth.getToken()}`,
                    },
                    body: JSON.stringify({
                        feedback_id: feedbackId,
                        decision: decision === 'accept_and_train' ? 'accept' : 'reject'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Feedback decision result:', result);

                showMessage('success', result.message || `Feedback ${decision.replace('_', ' ')} successfully!`);
                await loadFeedback(); // Reload the table

            } catch (error) {
                console.error('‚ùå Failed to decide on feedback:', error);
                showMessage('error', 'Failed to process feedback: ' + error.message);
            }
        }

        // Load training assets
        async function loadTrainingAssets() {
            console.log('üéØ Loading training assets...');

            const loading = document.getElementById('assets-loading');
            const table = document.getElementById('assets-table');
            const errorDiv = document.getElementById('assets-error');

            loading.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/admin-list-training-assets', {
                    headers: {
                        'Authorization': `Bearer ${window.flexicadAuth.getToken()}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Loaded training assets:', result);

                // Populate table
                const tbody = document.getElementById('assets-table-body');
                tbody.innerHTML = '';

                if (!result.items || result.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No training assets found.</td></tr>';
                } else {
                    result.items.forEach(asset => {
                        tbody.appendChild(createAssetRow(asset));
                    });
                }

                loading.style.display = 'none';
                table.style.display = 'table';

            } catch (error) {
                console.error('‚ùå Failed to load training assets:', error);
                loading.style.display = 'none';
                errorDiv.innerHTML = `<div class="error-message">Failed to load training assets: ${error.message}</div>`;
                errorDiv.style.display = 'block';
            }
        }

        // Create table row for training asset
        function createAssetRow(asset) {
            const row = document.createElement('tr');

            const statusClass = asset.status === 'active' ? 'status-active' : 'status-inactive';
            const fileSize = asset.file_size_mb ? `${asset.file_size_mb} MB` : '‚Äî';

            row.innerHTML = `
                <td><strong>${asset.name}</strong></td>
                <td>${asset.description || '‚Äî'}</td>
                <td>${fileSize}</td>
                <td><span class="status-badge ${statusClass}">${asset.status || 'unknown'}</span></td>
                <td>${new Date(asset.created_at).toLocaleDateString()}</td>
                <td>
                    <div class="action-buttons">
                        ${asset.preview_url ? 
                            `<button class="btn-small btn-secondary" onclick="previewAsset('${asset.id}')">Preview</button>` : 
                            ''}
                        ${asset.download_url ? 
                            `<a href="${asset.download_url}" class="btn-small btn-primary" target="_blank">Download</a>` : 
                            ''}
                    </div>
                </td>
            `;

            return row;
        }

        // Preview training asset
        async function previewAsset(assetId) {
            console.log('üëÅÔ∏è Previewing asset:', assetId);

            try {
                const response = await fetch(`/api/admin-preview-jsonl?asset_id=${assetId}`, {
                    headers: {
                        'Authorization': `Bearer ${window.flexicadAuth.getToken()}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úÖ Asset preview:', result);

                // Create a modal or popup to show the preview
                showAssetPreview(result);

            } catch (error) {
                console.error('‚ùå Failed to preview asset:', error);
                showMessage('error', 'Failed to preview asset: ' + error.message);
            }
        }

        // Show asset preview in a modal
        function showAssetPreview(previewData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>${previewData.asset.name} Preview</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Description:</strong> ${previewData.asset.description || 'No description'}</p>
                        <p><strong>File size:</strong> ${(previewData.asset.file_size / (1024 * 1024)).toFixed(2)} MB</p>
                        <p><strong>Lines shown:</strong> ${previewData.preview.shown_lines} of ${previewData.preview.total_lines} 
                           ${previewData.preview.truncated ? '(truncated)' : ''}</p>
                        
                        <h4>Structure Analysis:</h4>
                        <ul>
                            ${Object.entries(previewData.structure).map(([key, info]) => 
                                `<li><code>${key}</code> (${info.type}): ${info.examples.join(', ')}</li>`
                            ).join('')}
                        </ul>
                        
                        <h4>Sample Lines:</h4>
                        <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto;">
${previewData.lines.map(line => 
    `Line ${line.line}: ${JSON.stringify(line.content, null, 2)}`
).join('\n\n')}
                        </pre>
                        
                        ${previewData.parse_errors.length > 0 ? `
                            <h4 style="color: #ef4444;">Parse Errors (${previewData.parse_errors.length}):</h4>
                            <pre style="background: #fee; color: #c00; padding: 1rem; border-radius: 6px;">
${previewData.parse_errors.map(err => `Line ${err.line}: ${err.error}`).join('\n')}
                            </pre>
                        ` : ''}
                        
                        <p><strong>Success rate:</strong> ${previewData.stats.success_rate}</p>
                    </div>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            document.body.appendChild(modal);
        }

        // Logout function
        async function logout() {
            await window.flexicadAuth.logout();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing promo code management page...');

            // Check admin access first
            await checkAdminAccess();

            // Set up form handler
            document.getElementById('promo-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                await createPromoCode(data);
            });

            // Auto-uppercase promo code input
            document.getElementById('code').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        });
    </script>
</body>
</html>