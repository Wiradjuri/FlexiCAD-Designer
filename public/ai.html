<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiCAD Designer - AI Generator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/dark-theme.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">FlexiCAD Designer</a>
            <ul class="nav-links">
                <li><a href="home.html">Home</a></li>
                <li><a href="templates.html">Templates</a></li>
                <li><a href="ai.html" class="active">AI Generator</a></li>
                <li><a href="my-designs.html">My Designs</a></li>
                <li><a href="about.html">About</a></li>
                <li id="admin-link" style="display: none;"><a href="manage-promo.html" class="admin-nav">Admin</a></li>
            </ul>
            <div class="nav-user">
                <span class="user-info" id="userInfo"></span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">AI Design Generator</h1>
            <p class="page-subtitle">Describe your 3D design idea and let AI generate OpenSCAD code for you</p>
        </div>

        <div class="generator-layout">
            <div class="input-section">
                <div class="card">
                    <div class="card-title">Describe Your Design</div>
                    <div class="card-description mb-3">
                        Be specific about dimensions, features, and intended use. Examples:
                        <ul class="mt-2">
                            <li>"Create a phone case for iPhone 14 with camera cutouts"</li>
                            <li>"Design a desk organizer with 4 compartments for pens and paper clips"</li>
                            <li>"Make a wall mount bracket for a 24-inch monitor"</li>
                        </ul>
                    </div>
                    
                    <form id="generateForm">
                        <div class="form-group">
                            <label for="designPrompt" class="form-label">Design Description</label>
                            <textarea 
                                id="designPrompt" 
                                class="form-textarea" 
                                placeholder="Describe your 3D design in detail..."
                                required
                                rows="4"
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="designName" class="form-label">Design Name (optional)</label>
                            <input 
                                type="text" 
                                id="designName" 
                                class="form-input" 
                                placeholder="Enter a name for your design"
                            >
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <span class="btn-text">ðŸ¤– Generate Design</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </form>
                </div>

                <!-- Example Prompts -->
                <div class="card">
                    <div class="card-title">ðŸ’¡ Example Prompts</div>
                    <div class="card-description">
                        Try these example prompts to get started:
                    </div>
                    <div class="card-actions mt-2">
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Create a parametric box with rounded corners, 100mm long, 60mm wide, 40mm tall, with a removable lid')">
                            Parametric Box
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Design a desk phone stand with adjustable angle, suitable for smartphones between 4-7 inches')">
                            Phone Stand
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Make a wall-mounted key holder with 4 hooks and a small shelf for mail')">
                            Key Holder
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Create a cable management tray that mounts under a desk, 300mm long with multiple cable slots')">
                            Cable Tray
                        </button>
                    </div>
                </div>
            </div>

            <div class="output-section">
                <!-- Generated Code Display -->
                <div id="resultSection" class="hidden">
                    <div class="card">
                        <div class="card-title" id="resultTitle">Generated Design</div>
                        <div class="card-description" id="resultDescription"></div>
                        
                        <div class="code-container">
                            <div class="code-header">
                                <span id="resultFileName">generated-design.scad</span>
                                <div>
                                    <button class="btn btn-small btn-secondary" onclick="copyGeneratedCode(event)">Copy Code</button>
                                    <button class="btn btn-small btn-secondary" onclick="downloadGeneratedCode()">Download</button>
                                </div>
                            </div>
                            <pre class="code-block" id="generatedCode"></pre>
                        </div>
                        
                        <div class="card-actions mt-3">
                            <button class="btn btn-primary" onclick="saveDesign(event)">ðŸ’¾ Save to My Designs</button>
                            <button class="btn btn-secondary" onclick="generateAnother()">ðŸ”„ Generate Another</button>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorSection" class="hidden">
                    <div class="alert alert-error">
                        <span id="errorMessage"></span>
                    </div>
                </div>

                <!-- Placeholder for initial state -->
                <div id="placeholderSection" class="card placeholder-card">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ðŸ¤–</div>
                        <h3>AI-Generated Code Will Appear Here</h3>
                        <p>Enter your design description and click "Generate Design" to see the OpenSCAD code</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config/env-config.js"></script>
    <script src="config/config.js"></script>
    <script src="js/flexicad-auth.js"></script>
    <script>
        let currentGeneration = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user has paid access
            const hasAccess = await window.flexicadAuth.requireAuth();
            
            if (hasAccess) {
                console.log('User has paid access to AI Generator');
                
                // Display user info
                const userInfo = document.querySelector('.user-info');
                if (window.flexicadAuth.user && userInfo) {
                    userInfo.textContent = window.flexicadAuth.user.email || 'User';
                }

                // Show admin link if user is admin
                if (window.flexicadAuth.isAdmin()) {
                    const adminLink = document.getElementById('admin-link');
                    if (adminLink) {
                        adminLink.style.display = 'block';
                    }
                }
                
                // Initialize AI generation functionality
                initAIGenerator();
            }
        });

        function handleLogout() {
            window.flexicadAuth.logout();
        }

        function initAIGenerator() {
            console.log('AI Generator initialized for authenticated user');
            
            // AI generation form handler
            document.getElementById('generateForm').addEventListener('submit', handleGenerateSubmit);
        }

        // Handle form submission
        async function handleGenerateSubmit(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('designPrompt').value.trim();
            const name = document.getElementById('designName').value.trim();
            
            if (!prompt) {
                showError('Please enter a design description.');
                return;
            }
            
            await generateDesign(prompt, name);
        }

        async function generateDesign(prompt, name = '') {
            const submitBtn = document.querySelector('button[type="submit"]');
            
            setLoadingState(submitBtn, true);
            hideResults();
            hideError();
            hidePlaceholder();
            
            try {
                // Check if user is authenticated using session storage
                const userData = FlexiAuth.getUser();
                if (!userData) {
                    window.location.href = 'login.html';
                    return;
                }

                const sessionToken = await FlexiAuth.getSessionToken();
                
                if (!sessionToken) {
                    console.error('No session token available');
                    throw new Error('Authentication session expired. Please login again.');
                }

                const response = await fetch('/.netlify/functions/generate-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ prompt, name })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate design');
                }
                
                const result = await response.json();
                currentGeneration = {
                    prompt,
                    name: name || 'AI Generated Design',
                    code: result.code
                };
                
                displayResult(currentGeneration);
                
                // Auto-save the design to Supabase (don't let this fail the generation)
                try {
                    await autoSaveDesign();
                } catch (autoSaveError) {
                    console.error('Auto-save failed, but generation succeeded:', autoSaveError);
                }
                
            } catch (error) {
                console.error('Error generating design:', error);
                showError(`Failed to generate design: ${error.message}`);
                showPlaceholder();
            } finally {
                setLoadingState(submitBtn, false);
            }
        }

        function displayResult(generation) {
            document.getElementById('resultTitle').textContent = generation.name;
            document.getElementById('resultDescription').textContent = `Generated from: "${generation.prompt}"`;
            document.getElementById('resultFileName').textContent = `${generation.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            document.getElementById('generatedCode').textContent = generation.code;
            
            // Hide placeholder and show results
            document.getElementById('placeholderSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
        }

        async function autoSaveDesign() {
            if (!currentGeneration) {
                console.log('AutoSave skipped: No current generation');
                return;
            }
            
            try {
                const userData = FlexiAuth.getUser();
                if (!userData) {
                    console.log('AutoSave skipped: User not authenticated');
                    return;
                }
                
                const sessionToken = await FlexiAuth.getSessionToken();
                
                if (!sessionToken) {
                    console.log('AutoSave skipped: No session token');
                    return;
                }
                console.log('AutoSave: Attempting to save design...');
                
                // Auto-save to server
                const response = await fetch('/.netlify/functions/save-design', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken || ''}`
                    },
                    body: JSON.stringify({
                        prompt: currentGeneration.prompt,
                        code: currentGeneration.code,
                        name: currentGeneration.name || 'Auto-saved Design',
                        user_id: userData.id,
                        is_auto_save: true
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('AutoSave failed:', response.status, errorText);
                } else {
                    console.log('AutoSave successful');
                }
                
            } catch (error) {
                console.error('Error auto-saving design:', error.message || error);
                // Don't show error to user for auto-save failures
            }
        }

        async function saveDesign(event) {
            if (!currentGeneration) return;
            
            try {
                const userData = FlexiAuth.getUser();
                const sessionToken = await FlexiAuth.getSessionToken();
                
                if (!userData || !sessionToken) {
                    alert('Authentication required');
                    return;
                }

                // Send save request to server
                const response = await fetch('/.netlify/functions/save-design', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken || ''}`
                    },
                    body: JSON.stringify({
                        prompt: currentGeneration.prompt,
                        code: currentGeneration.code,
                        name: currentGeneration.name || 'Untitled Design',
                        user_id: userData.id
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save design');
                }

                const data = await response.json();
                
                // Visual feedback
                if (event && event.target) {
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… Saved!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                } else {
                    alert('Design saved successfully!');
                }
                
            } catch (error) {
                console.error('Error saving design:', error);
                alert('Failed to save design. Please try again.');
            }
        }

        function copyGeneratedCode(event) {
            if (!currentGeneration) return;
            
            navigator.clipboard.writeText(currentGeneration.code).then(() => {
                // Visual feedback
                if (event && event.target) {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 1000);
                }
            }).catch(() => {
                alert('Failed to copy code to clipboard');
            });
        }

        function downloadGeneratedCode() {
            if (!currentGeneration) return;
            
            const fileName = `${currentGeneration.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            const blob = new Blob([currentGeneration.code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateAnother() {
            document.getElementById('designPrompt').value = '';
            document.getElementById('designName').value = '';
            hideResults();
            hideError();
            showPlaceholder();
            document.getElementById('designPrompt').focus();
        }

        function useExamplePrompt(prompt) {
            document.getElementById('designPrompt').value = prompt;
            document.getElementById('designPrompt').focus();
        }

        function setLoadingState(button, loading) {
            const btnText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');
            
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
                btnText.textContent = 'Generating...';
                spinner.classList.remove('hidden');
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                btnText.textContent = 'ðŸ¤– Generate Design';
                spinner.classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultSection').classList.add('hidden');
        }

        function showPlaceholder() {
            document.getElementById('placeholderSection').classList.remove('hidden');
        }

        function hidePlaceholder() {
            document.getElementById('placeholderSection').classList.add('hidden');
        }

        // Use the FlexiAuth logout function
        async function handleLogout() {
            await FlexiAuth.logout();
        }

    </script>

    <style>
        .generator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
            max-width: 100vw;
            padding: 0 1rem;
            box-sizing: border-box;
        }

        .input-section, .output-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 0; /* Allows grid items to shrink below their content size */
            overflow: hidden;
        }

        .placeholder-card {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
        }

        .placeholder-content {
            text-align: center;
            color: var(--text-secondary);
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .code-container {
            margin: 1rem 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.875rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .code-block {
            padding: 1rem;
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Ensure cards don't overflow */
        .card {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Better button layout in code header */
        .code-header > div {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .generator-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                max-width: 100%;
            }
            
            .code-block {
                font-size: 0.8rem;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .generator-layout {
                padding: 0 0.5rem;
            }
            
            .code-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .code-header > div {
                width: 100%;
                justify-content: flex-start;
            }
            
            .code-block {
                font-size: 0.75rem;
                padding: 0.75rem;
            }
        }
    </style>
</body>
</html>