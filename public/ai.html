<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiCAD Designer - AI Generator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/dark-theme.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">FlexiCAD Designer</a>
            <ul class="nav-links">
                <li><a href="home.html">Home</a></li>
                <li><a href="templates.html">Templates</a></li>
                <li><a href="ai.html" class="active">AI Generator</a></li>
                <li><a href="my-designs.html">My Designs</a></li>
                <li><a href="about.html">About</a></li>
                <li id="admin-link" style="display: none;"><a href="manage-promo.html" class="admin-nav">Admin</a></li>
            </ul>
            <div class="nav-user">
                <span class="user-info" id="userInfo"></span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">AI Design Generator</h1>
            <p class="page-subtitle">Describe your 3D design idea and let AI generate OpenSCAD code for you</p>
        </div>

        <div class="generator-layout">
            <div class="input-section">
                <div class="card">
                    <div class="card-title">Describe Your Design</div>
                    <div class="card-description mb-3">
                        Be specific about dimensions, features, and intended use. Examples:
                        <ul class="mt-2">
                            <li>"Create a phone case for iPhone 14 with camera cutouts"</li>
                            <li>"Design a desk organizer with 4 compartments for pens and paper clips"</li>
                            <li>"Make a wall mount bracket for a 24-inch monitor"</li>
                        </ul>
                    </div>
                    
                    <form id="generateForm">
                        <div class="form-group">
                            <label for="designPrompt" class="form-label">Design Description</label>
                            <textarea 
                                id="designPrompt" 
                                class="form-textarea" 
                                placeholder="Describe your 3D design in detail..."
                                required
                                rows="4"
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="designName" class="form-label">Design Name (optional)</label>
                            <input 
                                type="text" 
                                id="designName" 
                                class="form-input" 
                                placeholder="Enter a name for your design"
                            >
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <span class="btn-text">ü§ñ Generate Design</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </form>
                </div>

                <!-- Example Prompts -->
                <div class="card">
                    <div class="card-title">üí° Example Prompts</div>
                    <div class="card-description">
                        Try these example prompts to get started:
                    </div>
                    <div class="card-actions mt-2">
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Create a parametric box with rounded corners, 100mm long, 60mm wide, 40mm tall, with a removable lid')">
                            Parametric Box
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Design a desk phone stand with adjustable angle, suitable for smartphones between 4-7 inches')">
                            Phone Stand
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Make a wall-mounted key holder with 4 hooks and a small shelf for mail')">
                            Key Holder
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="useExamplePrompt('Create a cable management tray that mounts under a desk, 300mm long with multiple cable slots')">
                            Cable Tray
                        </button>
                    </div>
                </div>
            </div>

            <div class="output-section">
                <!-- Generated Code Display -->
                <div id="resultSection" class="hidden">
                    <div class="card">
                        <div class="card-title" id="resultTitle">Generated Design</div>
                        <div class="card-description" id="resultDescription"></div>
                        
                        <div class="code-container">
                            <div class="code-header">
                                <span id="resultFileName">generated-design.scad</span>
                                <div>
                                    <button class="btn btn-small btn-secondary" onclick="copyGeneratedCode(event)">Copy Code</button>
                                    <button class="btn btn-small btn-secondary" onclick="downloadGeneratedCode()">Download</button>
                                </div>
                            </div>
                            <pre class="code-block" id="generatedCode"></pre>
                        </div>
                        
                        <div class="card-actions mt-3">
                            <button class="btn btn-primary" onclick="saveDesign(event)">üíæ Save to My Designs</button>
                            <button class="btn btn-secondary" onclick="generateAnother()">üîÑ Generate Another</button>
                        </div>
                    </div>
                    
                    <!-- AI Feedback Section -->
                    <div class="card mt-3" id="feedbackSection">
                        <div class="card-title">üìä Rate This Generation</div>
                        <div class="card-description mb-3">
                            Help improve the AI by rating this generation and providing feedback
                        </div>
                        
                        <div class="feedback-container">
                            <div class="rating-section">
                                <label class="form-label">How would you rate this generation?</label>
                                <div class="rating-stars" id="ratingStars">
                                    <span class="star" data-rating="1">‚≠ê</span>
                                    <span class="star" data-rating="2">‚≠ê</span>
                                    <span class="star" data-rating="3">‚≠ê</span>
                                    <span class="star" data-rating="4">‚≠ê</span>
                                    <span class="star" data-rating="5">‚≠ê</span>
                                </div>
                            </div>
                            
                            <div class="form-group mt-3">
                                <label for="feedbackText" class="form-label">Feedback (Optional)</label>
                                <textarea id="feedbackText" class="form-textarea" rows="3" placeholder="What could be improved? What did you like?"></textarea>
                            </div>
                            
                            <div class="form-group mt-3">
                                <label for="finalCode" class="form-label">Modified Code (Optional)</label>
                                <textarea id="finalCode" class="form-textarea code-textarea" rows="8" placeholder="If you modified the generated code, paste your improved version here to help the AI learn"></textarea>
                            </div>
                            
                            <div class="card-actions mt-3">
                                <button class="btn btn-primary" onclick="submitFeedback()" id="submitFeedbackBtn">Submit Feedback</button>
                                <button class="btn btn-secondary" onclick="collapseFeedback()">Skip</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Teaching Section -->
                    <div class="card mt-3" id="teachingSection" style="display: none;">
                        <div class="card-title">üéì Teach the AI</div>
                        <div class="card-description mb-3">
                            Add this as a learning example to improve future generations
                        </div>
                        
                        <form id="teachingForm">
                            <div class="form-group">
                                <label for="patternName" class="form-label">Pattern Name</label>
                                <input type="text" id="patternName" class="form-input" placeholder="e.g., 'Phone Case with Camera Cutouts'" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="patternDescription" class="form-label">Description</label>
                                <textarea id="patternDescription" class="form-textarea" rows="2" placeholder="Brief description of what this pattern creates"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="patternKeywords" class="form-label">Keywords (comma-separated)</label>
                                <input type="text" id="patternKeywords" class="form-input" placeholder="phone, case, protective, cutout, camera">
                            </div>
                            
                            <div class="form-group">
                                <label for="patternCategory" class="form-label">Category</label>
                                <select id="patternCategory" class="form-select">
                                    <option value="functional">Functional</option>
                                    <option value="mechanical">Mechanical</option>
                                    <option value="decorative">Decorative</option>
                                    <option value="toy">Toy/Game</option>
                                    <option value="electronic">Electronic</option>
                                    <option value="architectural">Architectural</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="complexityLevel" class="form-label">Complexity Level</label>
                                <select id="complexityLevel" class="form-select">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            
                            <div class="card-actions mt-3">
                                <button type="submit" class="btn btn-primary">üéì Teach AI</button>
                                <button type="button" class="btn btn-secondary" onclick="hideTeaching()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorSection" class="hidden">
                    <div class="alert alert-error">
                        <span id="errorMessage"></span>
                    </div>
                </div>

                <!-- Placeholder for initial state -->
                <div id="placeholderSection" class="card placeholder-card">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ü§ñ</div>
                        <h3>AI-Generated Code Will Appear Here</h3>
                        <p>Enter your design description and click "Generate Design" to see the OpenSCAD code</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/secure-config-loader.js"></script>
    <script src="js/flexicad-auth.js"></script>
    <script>
        let currentGeneration = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user has paid access
            const hasAccess = await window.flexicadAuth.requireAuth();
            
            if (hasAccess) {
                console.log('User has paid access to AI Generator');
                
                // Display user info
                const userInfo = document.querySelector('.user-info');
                if (window.flexicadAuth.user && userInfo) {
                    userInfo.textContent = window.flexicadAuth.user.email || 'User';
                }

                // Show admin link if user is admin
                if (window.flexicadAuth.isAdmin()) {
                    const adminLink = document.getElementById('admin-link');
                    if (adminLink) {
                        adminLink.style.display = 'block';
                    }
                }
                
                // Initialize AI generation functionality
                initAIGenerator();
            }
        });

        function handleLogout() {
            window.flexicadAuth.logout();
        }

        function initAIGenerator() {
            console.log('AI Generator initialized for authenticated user');
            
            // AI generation form handler
            document.getElementById('generateForm').addEventListener('submit', handleGenerateSubmit);
        }

        // Handle form submission
        async function handleGenerateSubmit(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('designPrompt').value.trim();
            const name = document.getElementById('designName').value.trim();
            
            if (!prompt) {
                showError('Please enter a design description.');
                return;
            }
            
            await generateDesign(prompt, name);
        }

        async function generateDesign(prompt, name = '') {
            const submitBtn = document.querySelector('button[type="submit"]');
            
            setLoadingState(submitBtn, true);
            hideResults();
            hideError();
            hidePlaceholder();
            
            try {
                // Check if user is authenticated using session storage
                const userData = FlexiAuth.getUser();
                if (!userData) {
                    window.location.href = 'login.html';
                    return;
                }

                const sessionToken = await FlexiAuth.getSessionToken();
                
                console.log('Session token type:', typeof sessionToken);
                console.log('Session token value:', sessionToken);
                
                if (!sessionToken || typeof sessionToken !== 'string') {
                    console.error('Invalid session token:', sessionToken);
                    throw new Error('Authentication session expired. Please login again.');
                }

                const response = await fetch('/.netlify/functions/generate-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ prompt, name })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate design');
                }
                
                const result = await response.json();
                currentGeneration = {
                    prompt,
                    name: name || result.name || 'AI Generated Design',
                    code: result.code,
                    metadata: result.metadata || {} // Include metadata for learning system
                };
                
                displayResult(currentGeneration);
                
                // Show feedback section for learning
                showFeedbackSection();
                
                // Auto-save the design to Supabase (don't let this fail the generation)
                try {
                    await autoSaveDesign();
                } catch (autoSaveError) {
                    console.error('Auto-save failed, but generation succeeded:', autoSaveError);
                }
                
            } catch (error) {
                console.error('Error generating design:', error);
                showError(`Failed to generate design: ${error.message}`);
                showPlaceholder();
            } finally {
                setLoadingState(submitBtn, false);
            }
        }

        function displayResult(generation) {
            document.getElementById('resultTitle').textContent = generation.name;
            
            let description = `Generated from: "${generation.prompt}"`;
            
            // Add metadata information if available
            if (generation.metadata) {
                const meta = generation.metadata;
                const metaInfo = [];
                
                if (meta.category) metaInfo.push(`Category: ${meta.category}`);
                if (meta.complexity) metaInfo.push(`Complexity: ${meta.complexity}`);
                if (meta.similarPatterns) metaInfo.push(`Similar patterns: ${meta.similarPatterns}`);
                if (meta.userExamples) metaInfo.push(`User examples: ${meta.userExamples}`);
                if (meta.generationTime) metaInfo.push(`Generated in: ${(meta.generationTime/1000).toFixed(1)}s`);
                
                if (metaInfo.length > 0) {
                    description += `\n\n${metaInfo.join(' ‚Ä¢ ')}`;
                }
            }
            
            document.getElementById('resultDescription').textContent = description;
            document.getElementById('resultFileName').textContent = `${generation.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            document.getElementById('generatedCode').textContent = generation.code;
            
            // Hide placeholder and show results
            document.getElementById('placeholderSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
        }

        async function autoSaveDesign() {
            if (!currentGeneration) {
                console.log('AutoSave skipped: No current generation');
                return;
            }
            
            try {
                const userData = FlexiAuth.getUser();
                if (!userData) {
                    console.log('AutoSave skipped: User not authenticated');
                    return;
                }
                
                const sessionToken = await FlexiAuth.getSessionToken();
                
                if (!sessionToken) {
                    console.log('AutoSave skipped: No session token');
                    return;
                }
                console.log('AutoSave: Attempting to save design...');
                
                // Auto-save to server
                const response = await fetch('/.netlify/functions/save-design', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken || ''}`
                    },
                    body: JSON.stringify({
                        prompt: currentGeneration.prompt,
                        code: currentGeneration.code,
                        name: currentGeneration.name || 'Auto-saved Design',
                        user_id: userData.id,
                        is_auto_save: true
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('AutoSave failed:', response.status, errorText);
                } else {
                    console.log('AutoSave successful');
                }
                
            } catch (error) {
                console.error('Error auto-saving design:', error.message || error);
                // Don't show error to user for auto-save failures
            }
        }

        async function saveDesign(event) {
            if (!currentGeneration) return;
            
            try {
                const userData = FlexiAuth.getUser();
                const sessionToken = await FlexiAuth.getSessionToken();
                
                if (!userData || !sessionToken) {
                    alert('Authentication required');
                    return;
                }

                // Send save request to server
                const response = await fetch('/.netlify/functions/save-design', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken || ''}`
                    },
                    body: JSON.stringify({
                        prompt: currentGeneration.prompt,
                        code: currentGeneration.code,
                        name: currentGeneration.name || 'Untitled Design',
                        user_id: userData.id
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save design');
                }

                const data = await response.json();
                
                // Visual feedback
                if (event && event.target) {
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Saved!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                } else {
                    alert('Design saved successfully!');
                }
                
            } catch (error) {
                console.error('Error saving design:', error);
                alert('Failed to save design. Please try again.');
            }
        }

        function copyGeneratedCode(event) {
            if (!currentGeneration) return;
            
            navigator.clipboard.writeText(currentGeneration.code).then(() => {
                // Visual feedback
                if (event && event.target) {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 1000);
                }
            }).catch(() => {
                alert('Failed to copy code to clipboard');
            });
        }

        function downloadGeneratedCode() {
            if (!currentGeneration) return;
            
            const fileName = `${currentGeneration.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            const blob = new Blob([currentGeneration.code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateAnother() {
            document.getElementById('designPrompt').value = '';
            document.getElementById('designName').value = '';
            hideResults();
            hideError();
            showPlaceholder();
            document.getElementById('designPrompt').focus();
        }

        function useExamplePrompt(prompt) {
            document.getElementById('designPrompt').value = prompt;
            document.getElementById('designPrompt').focus();
        }

        function setLoadingState(button, loading) {
            const btnText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');
            
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
                btnText.textContent = 'Generating...';
                spinner.classList.remove('hidden');
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                btnText.textContent = 'ü§ñ Generate Design';
                spinner.classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('resultSection').classList.add('hidden');
        }

        function showPlaceholder() {
            document.getElementById('placeholderSection').classList.remove('hidden');
        }

        function hidePlaceholder() {
            document.getElementById('placeholderSection').classList.add('hidden');
        }

        // AI Learning and Feedback Functions
        let currentRating = 0;

        // Initialize rating stars
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    setRating(rating);
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });

            // Reset star highlighting when not hovering
            document.getElementById('ratingStars').addEventListener('mouseleave', function() {
                highlightStars(currentRating);
            });

            // Teaching form submission
            document.getElementById('teachingForm').addEventListener('submit', handleTeachingSubmit);
        });

        function setRating(rating) {
            currentRating = rating;
            highlightStars(rating);
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        async function submitFeedback() {
            if (currentRating === 0) {
                alert('Please select a rating first');
                return;
            }

            if (!currentGeneration || !currentGeneration.metadata || !currentGeneration.metadata.sessionId) {
                alert('No generation session found');
                return;
            }

            const submitBtn = document.getElementById('submitFeedbackBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const user = JSON.parse(sessionStorage.getItem('flexicad_user'));
                const token = sessionStorage.getItem('flexicad_session_token');

                if (!user || !token) {
                    throw new Error('Authentication required');
                }

                const feedbackData = {
                    sessionId: currentGeneration.metadata.sessionId,
                    feedback: currentRating,
                    finalCode: document.getElementById('finalCode').value.trim() || null,
                    correctionType: document.getElementById('finalCode').value.trim() ? 'improvement' : null,
                    correctionDescription: document.getElementById('feedbackText').value.trim() || null
                };

                const response = await fetch('/.netlify/functions/ai-feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(feedbackData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to submit feedback');
                }

                console.log('‚úÖ Feedback submitted successfully');
                
                // Show success message and hide feedback form
                submitBtn.textContent = '‚úÖ Thanks!';
                submitBtn.style.background = 'var(--success)';
                
                // If rating is high, offer to teach the AI
                if (currentRating >= 4) {
                    setTimeout(() => {
                        document.getElementById('teachingSection').style.display = 'block';
                        prepareTeachingForm();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        collapseFeedback();
                    }, 2000);
                }

            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Failed to submit feedback: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Feedback';
            }
        }

        function collapseFeedback() {
            document.getElementById('feedbackSection').style.display = 'none';
            // Reset feedback form
            currentRating = 0;
            highlightStars(0);
            document.getElementById('feedbackText').value = '';
            document.getElementById('finalCode').value = '';
            document.getElementById('submitFeedbackBtn').disabled = false;
            document.getElementById('submitFeedbackBtn').textContent = 'Submit Feedback';
            document.getElementById('submitFeedbackBtn').style.background = '';
        }

        function prepareTeachingForm() {
            if (!currentGeneration) return;

            // Pre-fill form with generation data
            const promptText = currentGeneration.prompt || '';
            const generatedName = currentGeneration.name || 'AI Generated Design';
            
            document.getElementById('patternName').value = generatedName;
            document.getElementById('patternDescription').value = `Learned from: ${promptText.substring(0, 100)}${promptText.length > 100 ? '...' : ''}`;
            
            // Extract keywords from prompt
            const keywords = promptText.toLowerCase()
                .match(/\b\w{4,}\b/g) || [];
            const uniqueKeywords = [...new Set(keywords)]
                .filter(word => !['this', 'that', 'with', 'from', 'create', 'make', 'design'].includes(word))
                .slice(0, 8);
            
            document.getElementById('patternKeywords').value = uniqueKeywords.join(', ');
            
            // Set category based on metadata
            if (currentGeneration.metadata && currentGeneration.metadata.category) {
                document.getElementById('patternCategory').value = currentGeneration.metadata.category;
            }
            
            // Set complexity based on metadata
            if (currentGeneration.metadata && currentGeneration.metadata.complexity) {
                document.getElementById('complexityLevel').value = currentGeneration.metadata.complexity;
            }
        }

        async function handleTeachingSubmit(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üéì Teaching...';

            try {
                const user = JSON.parse(sessionStorage.getItem('flexicad_user'));
                const token = sessionStorage.getItem('flexicad_session_token');

                if (!user || !token) {
                    throw new Error('Authentication required');
                }

                // Get final code (user's version or original generated code)
                const finalCode = document.getElementById('finalCode').value.trim() || currentGeneration.code;

                const teachingData = {
                    patternName: document.getElementById('patternName').value.trim(),
                    description: document.getElementById('patternDescription').value.trim(),
                    keywords: document.getElementById('patternKeywords').value.trim(),
                    examplePrompt: currentGeneration.prompt,
                    successfulCode: finalCode,
                    category: document.getElementById('patternCategory').value,
                    complexityLevel: document.getElementById('complexityLevel').value,
                    updateFileSystem: true
                };

                const response = await fetch('/.netlify/functions/teach-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(teachingData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to teach AI');
                }

                console.log('‚úÖ AI teaching successful:', result);
                
                // Show success
                submitBtn.textContent = '‚úÖ AI Learned!';
                submitBtn.style.background = 'var(--success)';
                
                setTimeout(() => {
                    hideTeaching();
                }, 2000);

            } catch (error) {
                console.error('Error teaching AI:', error);
                alert('Failed to teach AI: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üéì Teach AI';
            }
        }

        function hideTeaching() {
            document.getElementById('teachingSection').style.display = 'none';
            document.getElementById('teachingForm').reset();
        }

        // Show feedback section after generation
        function showFeedbackSection() {
            document.getElementById('feedbackSection').style.display = 'block';
            // Scroll to feedback section
            setTimeout(() => {
                document.getElementById('feedbackSection').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 500);
        }

        // Use the FlexiAuth logout function
        async function handleLogout() {
            await FlexiAuth.logout();
        }

    </script>

    <style>
        .generator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
            max-width: 100vw;
            padding: 0 1rem;
            box-sizing: border-box;
        }

        .input-section, .output-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 0; /* Allows grid items to shrink below their content size */
            overflow: hidden;
        }

        .placeholder-card {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
        }

        .placeholder-content {
            text-align: center;
            color: var(--text-secondary);
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .code-container {
            margin: 1rem 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 0.875rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .code-block {
            padding: 1rem;
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Ensure cards don't overflow */
        .card {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Better button layout in code header */
        .code-header > div {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .generator-layout {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                max-width: 100%;
            }
            
            .code-block {
                font-size: 0.8rem;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .generator-layout {
                padding: 0 0.5rem;
            }
            
            .code-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .code-header > div {
                width: 100%;
                justify-content: flex-start;
            }
            
            .code-block {
                font-size: 0.75rem;
                padding: 0.75rem;
            }
        }

        /* Feedback and Teaching UI Styles */
        .feedback-container {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .rating-section {
            text-align: center;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .star {
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .star:hover,
        .star.selected {
            opacity: 1;
        }

        .star.selected {
            filter: drop-shadow(0 0 3px gold);
        }

        .code-textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .form-textarea,
        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        .teaching-hidden {
            display: none !important;
        }
    </style>
</body>
</html>