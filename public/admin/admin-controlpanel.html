<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - FlexiCAD Designer</title>
    <link rel="stylesheet" href="../css/dark-theme.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--primary-bg);
            border-radius: 10px;
            border: 1px solid var(--accent-blue);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .admin-card {
            background: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .card-header {
            background: var(--primary-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--accent-blue);
        }
        
        .card-content {
            padding: 1rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background: var(--success-color); }
        .status-warning { background: var(--warning-color); }
        .status-error { background: var(--error-color); }
        .status-unknown { background: var(--text-secondary); }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .admin-table th,
        .admin-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-table th {
            background: var(--primary-bg);
        }
        
        .admin-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

    .dashboard-overview {
      margin: 2rem 0 3rem 0;
      display: grid;
      gap: 2rem;
    }

    .dashboard-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .dashboard-stat-card {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--accent-blue);
      line-height: 1.2;
    }

    .stat-value.error {
      color: var(--error-color);
    }

    .recent-activity-card {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 1.5rem;
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .activity-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text-primary);
    }

    .recent-activity-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .recent-activity-list.loading {
      color: var(--text-secondary);
    }

    .recent-activity-list.error {
      color: var(--error-color);
    }

    .activity-placeholder {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .training-assets-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .training-assets-summary {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .training-assets-table .tag-pill,
    .feedback-tags .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      margin: 0 0.25rem 0.25rem 0;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--primary-bg);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .tag-pill-empty {
      font-style: italic;
      opacity: 0.7;
    }

    .training-assets-table tbody tr.curated-row {
      background: rgba(76, 205, 196, 0.08);
    }

    .asset-name {
      font-weight: 600;
    }

    .asset-path {
      font-size: 0.75rem;
      color: var(--text-secondary);
      word-break: break-all;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .status-badge.status-primary {
      background: rgba(59, 130, 246, 0.18);
      color: var(--accent-blue);
    }

    .status-badge.status-neutral {
      background: rgba(148, 163, 184, 0.18);
      color: var(--text-secondary);
    }

    .status-badge.pending { background: rgba(255, 196, 0, 0.18); color: var(--warning-color); }
    .status-badge.accepted { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }
    .status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: var(--error-color); }

    .jsonl-preview-modal {
      max-width: 720px;
    }

    .jsonl-keys {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .jsonl-line {
      display: grid;
      grid-template-columns: 3rem 1fr;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: var(--primary-bg);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .jsonl-line-number {
      color: var(--accent-blue);
      font-weight: 600;
    }

    .jsonl-line pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .jsonl-line-content {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .jsonl-line-error {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(239, 68, 68, 0.1);
    }

    .jsonl-error-message {
      color: var(--error-color);
      font-weight: 600;
    }

    .preview-meta {
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .preview-content {
      max-height: 420px;
      overflow-y: auto;
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .training-assets-pagination {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .feedback-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .feedback-card {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 1rem;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .feedback-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .feedback-author {
      font-weight: 600;
    }

    .feedback-timestamp {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .feedback-snippet {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .feedback-snippet strong {
      color: var(--text-primary);
    }

    .feedback-status {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .feedback-reviewer {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .feedback-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .feedback-summary {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .feedback-quality {
      font-size: 0.8rem;
      color: var(--accent-blue);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .feedback-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .feedback-modal-content {
      max-width: 800px;
      max-height: 75vh;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .feedback-modal-body {
      max-height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .modal-section h4 {
      margin-bottom: 0.5rem;
    }

    .modal-pre {
      background: var(--bg-tertiary);
      border-radius: 4px;
      padding: 0.75rem;
      font-family: "Fira Code", "Courier New", monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid var(--border-color);
    }

    .modal-footer.actions-right {
      justify-content: flex-end;
    }

    .empty-state {
      padding: 1rem;
      border-radius: 6px;
      border: 1px dashed var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      text-align: center;
    }

    .error-text {
      color: var(--error-color);
    }

    .hidden { display: none !important; }
    .mt-1 { margin-top: 1rem; }
    .mt-05 { margin-top: 0.5rem; }
    .mb-1 { margin-bottom: 1rem; }
    .mb-05 { margin-bottom: 0.5rem; }
    .mr-05 { margin-right: 0.5rem; }
    .w-100 { width: 100%; }
    .maxw-200 { max-width: 200px; }
    .monospace-note { font-family: 'Courier New', monospace; font-size: 0.8rem; }
  .log-pre { font-size: 0.8rem; color: var(--text-secondary); }
    .config-pre {
      font-size: 0.8rem;
      background: var(--primary-bg);
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
      border: 1px solid var(--border-color);
    }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .section-full {
            grid-column: 1 / -1;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .modal-header {
            background: var(--primary-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            background: var(--primary-bg);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .feedback-detail {
            margin-bottom: 1.5rem;
        }
        
        .feedback-text {
            background: var(--primary-bg);
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .feedback-code {
            background: var(--primary-bg);
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-close:hover {
            background: var(--error-color);
            border-radius: 50%;
        }

        /* Learning Indicator Pills */
        .learning-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .learning-none {
            background: var(--error-color);
            color: white;
        }
        
        .learning-engaged {
            background: var(--warning-color);
            color: white;
        }
        
        .learning-rich {
            background: var(--success-color);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-brand">FlexiCAD Designer - Admin Console</div>
            <ul class="nav-links">
                <li><a href="../ai.html">‚Üê Back to App</a></li>
                <li><button onclick="handleLogout()" class="nav-link btn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>üîß FlexiCAD Admin Console</h1>
            <p>Unified management dashboard for FlexiCAD Designer</p>
            <div id="admin-status">Checking admin permissions...</div>
        </div>

  <div id="admin-content" class="hidden">
        <section class="dashboard-overview">
            <div class="dashboard-stats-grid">
                <div class="dashboard-stat-card">
                    <span class="stat-label">Total Users</span>
                    <span class="stat-value loading" data-stat="total-users">Loading...</span>
                </div>
                <div class="dashboard-stat-card">
                    <span class="stat-label">Active Today</span>
                    <span class="stat-value loading" data-stat="active-today">Loading...</span>
                </div>
                <div class="dashboard-stat-card">
                    <span class="stat-label">Total Designs</span>
                    <span class="stat-value loading" data-stat="total-designs">Loading...</span>
                </div>
            </div>

            <div class="recent-activity-card">
                <div class="activity-header">
                    <h2>Recent Activity</h2>
                    <button type="button" class="btn btn-secondary btn-small" id="refresh-dashboard-activity">Refresh</button>
                </div>
                <div class="recent-activity-list loading" data-activity="recent">
                    <div class="activity-placeholder">Loading recent activity...</div>
                </div>
            </div>
        </section>

        <section class="admin-navigation-section">
          <h2>Admin Tools</h2>
          <div class="admin-nav-grid">
            <a href="/admin/access-control.html" class="admin-nav-card">
              <div class="nav-card-icon">üë•</div>
              <h3>Access Control</h3>
              <p>Manage user accounts, permissions, and admin access</p>
            </a>

            <a href="/admin/payment-management.html" class="admin-nav-card">
              <div class="nav-card-icon">üí≥</div>
              <h3>Payment Management</h3>
              <p>View payment history, subscriptions, and transactions</p>
            </a>

            <a href="/admin/ai-management.html" class="admin-nav-card">
              <div class="nav-card-icon">ü§ñ</div>
              <h3>AI Management</h3>
              <p>Manage training data, feedback, and AI model settings</p>
            </a>

            <a href="/admin/system-tools.html" class="admin-nav-card">
              <div class="nav-card-icon">üîß</div>
              <h3>System Tools</h3>
              <p>System health, diagnostics, and configuration</p>
            </a>
          </div>
        </section>

            <div class="admin-grid">
                <!-- Health & Connectivity Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="health-status"></span>
                        Health & Connectivity
                    </div>
                    <div class="card-content">
                        <div id="health-details">Loading system health...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="checkSystemHealth()" class="btn btn-secondary btn-small">üîÑ Refresh Health</button>
                        </div>
                    </div>
                </div>

                <!-- Stripe Integration Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="stripe-status"></span>
                        Stripe Integration (Test Mode)
                    </div>
                    <div class="card-content">
                        <div id="stripe-details">Ready for testing...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="openTestCheckout()" class="btn btn-primary btn-small">üí≥ Open Test Checkout</button>
                            <button onclick="verifyEntitlement()" class="btn btn-secondary btn-small">‚úÖ Verify Entitlement</button>
                        </div>
                        <div id="test-email-input" class="hidden mt-1">
                            <input type="email" id="test-email" class="form-input" placeholder="Test email (optional)" 
                                   value="admin+test@flexicad.com.au">
                            <button onclick="createTestCheckout()" class="btn btn-primary btn-small">Create Session</button>
                        </div>
                    </div>
                </div>

                <!-- Auth Flow Tests Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Auth Flow Quick Tests
                    </div>
                    <div class="card-content">
                        <div>Test authentication flows with real providers</div>
                        <div class="admin-actions mt-1">
                            <button onclick="openRegisterTest()" class="btn btn-secondary btn-small">üìù Open Register Test</button>
                            <button onclick="openLoginTest()" class="btn btn-secondary btn-small">üîë Open Login Test</button>
                            <button onclick="sessionEcho()" class="btn btn-secondary btn-small">üîä Session Echo</button>
                        </div>
                        <div id="session-echo-result" class="mt-05 monospace-note"></div>
                    </div>
                </div>

                <!-- AI Generation Tests Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="ai-status"></span>
                        AI Generation Smoke Test
                    </div>
                    <div class="card-content">
                        <div id="ai-details">Ready for testing...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="runAISmokeTest()" class="btn btn-primary btn-small">ü§ñ Run AI Smoke Test</button>
                        </div>
                        <div id="ai-test-result" class="mt-05 monospace-note"></div>
                    </div>
                </div>

                <!-- Promo Codes Management Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Promo Codes Management
                    </div>
                    <div class="card-content">
                        <div>Create and manage discount codes</div>
                        <div class="admin-actions mt-1">
                            <button onclick="window.location.href='../manage-promo.html'" class="btn btn-primary btn-small">üéüÔ∏è Manage Promo Codes</button>
                        </div>
                    </div>
                </div>

                <!-- User Entitlements Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="users-status"></span>
                        User Entitlements
                    </div>
                    <div class="card-content">
                        <div id="user-stats">Loading user statistics...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="loadUserStats()" class="btn btn-secondary btn-small">üë• Load User Stats</button>
                        </div>
                    </div>
                </div>

                <!-- Recent Knowledge Usage Card - Phase 4.6.1 -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Recent Knowledge Usage
                    </div>
                    <div class="card-content">
                        <div id="knowledge-usage">No recent knowledge pack usage...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="loadRecentKnowledgeUsage()" class="btn btn-secondary btn-small">üì¶ Refresh Usage</button>
                        </div>
                    </div>
                </div>

                <!-- Runtime Config Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Runtime Configuration (Read-Only)
                    </div>
                    <div class="card-content">
                        <div id="config-display">Loading configuration...</div>
                        <div class="admin-actions mt-1">
                            <button onclick="displayConfig()" class="btn btn-secondary btn-small">üîß Show Config</button>
                            <button id="reveal-key-btn" onclick="toggleKeyVisibility()" class="btn btn-secondary btn-small hidden">üëÅÔ∏è Reveal Keys</button>
                        </div>
                    </div>
                </div>

                <!-- Feedback Review Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="feedback-status"></span>
                        Feedback Review & Training
                    </div>
                    <div class="card-content">
                        <div class="admin-actions mb-1">
                            <select id="feedback-status-filter" class="form-input mr-05">
                                <option value="pending">Pending Review</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <input type="text" id="feedback-search" class="form-input mr-05 maxw-200" placeholder="Search...">
                            <button onclick="loadFeedbackReview()" class="btn btn-secondary btn-small">üîÑ Load Feedback</button>
                        </div>
                        <div id="feedback-list">Click "Load Feedback" to view user feedback for review</div>
                    </div>
                </div>

                <!-- Training Assets Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Training Assets (SVG/SCAD/JSONL)
                    </div>
                    <div class="card-content">
                        <div class="admin-actions mb-1">
                            <input type="file" id="asset-file-input" accept=".svg,.scad,.jsonl" class="mr-05">
                            <button onclick="uploadTrainingAsset()" class="btn btn-primary btn-small">üì§ Upload Asset</button>
                            <button onclick="loadTrainingAssets()" class="btn btn-secondary btn-small">üîÑ Refresh List</button>
                        </div>
                        <div id="training-assets-list">Click "Refresh List" to view uploaded training assets</div>
                    </div>
                </div>

                <!-- AI Generator Knowledge Test -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="knowledge-indicator"></span>
                        AI Generator Knowledge Test
                    </div>
                    <div class="card-content">
            <div class="mb-1">
              <textarea id="knowledge-prompt" class="form-input w-100 mb-05" placeholder="Enter a test prompt..." rows="3">Create a simple cube with 10mm sides</textarea>
              <select id="knowledge-template" class="form-input mr-05">
                                <option value="">All templates</option>
                                <option value="general">General</option>
                                <option value="mechanical">Mechanical</option>
                                <option value="artistic">Artistic</option>
                            </select>
                            <button onclick="runKnowledgeTest()" class="btn btn-primary btn-small">üß† Run Test</button>
                        </div>
            <div id="knowledge-results" class="hidden">
              <div id="learning-indicator-display" class="mb-1"></div>
              <div id="knowledge-examples" class="mb-1"></div>
              <div id="knowledge-assets" class="mb-1"></div>
                            <details id="knowledge-log">
                                <summary>Debug Log</summary>
                                <pre id="knowledge-log-content" class="log-pre"></pre>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback View Modal -->
  <div id="feedback-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Feedback Details</h3>
                <button onclick="closeFeedbackModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feedback-detail">
                    <h4>Design Prompt</h4>
                    <div id="modal-design-prompt" class="feedback-text"></div>
                </div>
                <div class="feedback-detail">
                    <h4>User Feedback</h4>
                    <div id="modal-feedback-text" class="feedback-text"></div>
                </div>
                <div class="feedback-detail">
                    <h4>Generated Code</h4>
                    <pre id="modal-generated-code" class="feedback-code"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeFeedbackModal()" class="btn btn-secondary">Close</button>
                <button onclick="decideFeedback(getCurrentModalFeedbackId(), 'reject')" class="btn btn-secondary">‚ùå Reject</button>
                <button onclick="decideFeedback(getCurrentModalFeedbackId(), 'accept')" class="btn btn-primary">‚úÖ Accept & Train</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="../js/secure-config-loader.js"></script>
<script src="../js/flexicad-auth.js"></script>
<script>
  let adminUser = null;
  let supabaseClient = null;
  let dashboardStatsInterval = null;

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üîß Initializing Admin Console...');
    const statusEl = document.getElementById('admin-status');
    statusEl.innerHTML = '<span class="loading-spinner"></span> Validating admin permissions...';

    try {
      await window.flexicadAuth.init();

      if (!window.flexicadAuth.user) {
        showAdminError('Not authenticated. Redirecting to login...');
        setTimeout(() => (window.location.href = '../login.html'), 2000);
        return;
      }

      adminUser = window.flexicadAuth.user;
      supabaseClient = window.flexicadAuth.getSupabaseClient();
      if (!supabaseClient) {
        throw new Error('Supabase client unavailable');
      }

      const refreshButton = document.getElementById('refresh-dashboard-activity');
      if (refreshButton) {
        refreshButton.addEventListener('click', (event) => {
          event.preventDefault();
          loadDashboardStats();
        });
      }

      let healthSnapshot;
      try {
        healthSnapshot = await ensureAdminAccess();
      } catch (error) {
        console.error('Admin access validation failed:', error);
        showAdminError('Access denied. Redirecting to AI Generator...');
        setTimeout(() => (window.location.href = '../ai.html'), 2500);
        return;
      }

      statusEl.innerHTML = `<span style="color: var(--success-color);">‚úÖ Admin access confirmed: ${adminUser.email}</span>`;
      document.getElementById('admin-content').style.display = 'block';

      await Promise.all([
        loadDashboardStats(),
        checkSystemHealth(healthSnapshot),
        loadUserStats(),
        displayConfig(),
        loadFeedbackReview(),
        loadTrainingAssets()
      ]);

      if (!dashboardStatsInterval) {
        dashboardStatsInterval = setInterval(loadDashboardStats, 60000);
      }
    } catch (error) {
      console.error('Failed to initialize admin console:', error);
      showAdminError(`Initialization failed: ${error.message}`);
    }
  });

  window.addEventListener('beforeunload', () => {
    if (dashboardStatsInterval) {
      clearInterval(dashboardStatsInterval);
      dashboardStatsInterval = null;
    }
  });

  // Modal click-outside handler
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('feedback-modal');
    if (e.target === modal) {
      closeFeedbackModal();
    }
  });

  function showAdminError(message) {
    document.getElementById('admin-status').innerHTML =
      `<span style="color: var(--error-color);">‚ùå ${message}</span>`;
  }

  async function ensureAdminAccess() {
    const token = await window.flexicadAuth.getSessionToken();
    if (!token) {
      throw new Error('Authentication token unavailable');
    }

    const response = await fetch('/.netlify/functions/admin-health', {
      headers: { Authorization: `Bearer ${token}` }
    });

    let data = {};
    try {
      data = await response.json();
    } catch (_) {
      data = {};
    }

    if (!response.ok || data?.ok !== true) {
      const error = new Error(data?.error || `Admin validation failed (${response.status})`);
      error.status = response.status;
      throw error;
    }

    return data;
  }

  // ---------------- Dashboard stats ----------------
  async function loadDashboardStats() {
    const statElements = {
      totalUsers: document.querySelector('[data-stat="total-users"]'),
      activeToday: document.querySelector('[data-stat="active-today"]'),
      totalDesigns: document.querySelector('[data-stat="total-designs"]')
    };
    const recentActivityEl = document.querySelector('[data-activity="recent"]');

    Object.values(statElements).forEach((el) => {
      if (!el) return;
      el.textContent = 'Loading...';
      el.classList.remove('error');
      el.classList.add('loading');
    });

    if (recentActivityEl) {
      recentActivityEl.innerHTML = '<div class="activity-placeholder">Loading recent activity...</div>';
      recentActivityEl.classList.remove('error');
      recentActivityEl.classList.add('loading');
    }

    try {
      let accessToken = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      if (!accessToken && window.flexicadAuth?.getSessionToken) {
        accessToken = await window.flexicadAuth.getSessionToken();
      }

      if (!accessToken) {
        throw new Error('No authentication token available');
      }

      const response = await fetch('/.netlify/functions/admin-dashboard-stats', {
        method: 'GET',
        headers: { Authorization: `Bearer ${accessToken}` }
      });

      const payload = await response.json().catch(() => ({ ok: false, error: 'Invalid server response' }));
      if (!response.ok || !payload.ok) {
        throw new Error(payload.error || `Request failed (${response.status})`);
      }

      // New response structure: { ok, totals, activeToday, recentActivity, config }
      const { totals, activeToday, recentActivity } = payload;

      if (statElements.totalUsers) {
        statElements.totalUsers.textContent = totals?.users ?? 0;
        statElements.totalUsers.classList.remove('loading', 'error');
      }
      if (statElements.activeToday) {
        statElements.activeToday.textContent = activeToday?.users ?? 0;
        statElements.activeToday.classList.remove('loading', 'error');
      }
      if (statElements.totalDesigns) {
        statElements.totalDesigns.textContent = totals?.designs ?? 0;
        statElements.totalDesigns.classList.remove('loading', 'error');
      }

      if (recentActivityEl) {
        const recent = Array.isArray(recentActivity) ? recentActivity : [];
        if (recent.length === 0) {
          recentActivityEl.innerHTML = '<div class="no-activity">No recent activity</div>';
        } else {
          recentActivityEl.innerHTML = recent
            .map((activity) => {
              const safeBy = escapeHtml(activity.by || 'Unknown user');
              const safeSummary = escapeHtml(activity.summary || 'No summary');
              const activityTime = activity.at ? new Date(activity.at).toLocaleString() : 'Unknown time';
              const typeIcon = activity.type === 'design' ? 'üé®' : 'üí¨';
              return `
                <div class="activity-item">
                  <div class="activity-type">${typeIcon} ${escapeHtml(activity.type)}</div>
                  <div class="activity-user">${safeBy}</div>
                  <div class="activity-summary">${safeSummary}</div>
                  <div class="activity-time">${escapeHtml(activityTime)}</div>
                </div>
              `;
            })
            .join('');
        }
        recentActivityEl.classList.remove('loading', 'error');
      }
    } catch (error) {
      console.error('Dashboard stats load failed:', error);
      showDashboardStatsError(error.message);
    }
  }

  function showDashboardStatsError(message) {
    const statEls = document.querySelectorAll('[data-stat]');
    statEls.forEach((el) => {
      el.textContent = 'Error';
      el.classList.remove('loading');
      el.classList.add('error');
    });

    const recentActivityEl = document.querySelector('[data-activity="recent"]');
    if (recentActivityEl) {
      const safeMessage = escapeHtml(message || 'Failed to load activity');
      recentActivityEl.innerHTML = `<div class="error-message">${safeMessage}</div>`;
      recentActivityEl.classList.remove('loading');
      recentActivityEl.classList.add('error');
    }
  }

  // ---------------- Health ----------------
  async function checkSystemHealth(prefetchedHealth) {
    const statusEl = document.getElementById('health-status');
    const detailsEl = document.getElementById('health-details');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Checking system health...';

    try {
      let health = prefetchedHealth;
      if (!health) {
        const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
        if (!token) throw new Error('No authentication token available');

        const res = await fetch('/.netlify/functions/admin-health', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`Health check failed: ${res.status}`);
        health = await res.json();
        if (!health.ok) throw new Error(health.error || 'Health check returned not ok');
      }

      const supabaseOk = !!health.supabase?.ok;
      const stripeOk   = !!health.stripe?.ok;
      const openaiOk   = !!health.openai?.ok;
      const isLiveMode = health.stripe?.mode === 'live';
      const allOk = supabaseOk && stripeOk && openaiOk;

      statusEl.className = `status-indicator ${allOk ? 'status-ok' : 'status-warning'}`;

      const stripeWarning = isLiveMode
        ? '<br><span style="color: var(--warning-color);">‚ö†Ô∏è Live keys detected ‚Äî switch to Test Mode to use admin tests</span>'
        : '';

      detailsEl.innerHTML = `
        <div>Supabase: <span style="color: ${supabaseOk ? 'var(--success-color)' : 'var(--error-color)'}">${supabaseOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span></div>
        <div>Stripe: <span style="color: ${stripeOk ? 'var(--success-color)' : 'var(--error-color)'}">${stripeOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span> (${health.stripe?.mode} mode)${stripeWarning}</div>
        <div>OpenAI: <span style="color: ${openaiOk ? 'var(--success-color)' : 'var(--error-color)'}">${openaiOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span> (${health.openai?.model})</div>
        <div style="margin-top: .5rem; font-size: .8rem;">Environment: ${health.env?.mode} | Node ${health.env?.node} | Rev: ${health.env?.rev}</div>
      `;

      document
        .querySelectorAll('[onclick*="createTestCheckout"], [onclick*="verifyEntitlement"]')
        .forEach(btn => {
          if (isLiveMode) { btn.disabled = true; btn.title = 'Disabled - Live keys detected'; btn.style.opacity = '0.5'; }
          else { btn.disabled = false; btn.title = ''; btn.style.opacity = '1'; }
        });
    } catch (error) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Health check failed: ${error.message}</span>`;
    }
  }

  // ---------------- Stripe tests ----------------
  function openTestCheckout() {
    const el = document.getElementById('test-email-input');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }

  async function createTestCheckout() {
    const email = document.getElementById('test-email').value || `admin+e2e-${Date.now()}@example.com`;
    const detailsEl = document.getElementById('stripe-details');
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Creating test checkout...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-create-test-checkout', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (!data.ok || !data.url) throw new Error(data.error || 'Failed to create checkout session');

      window.open(data.url, '_blank');
      detailsEl.innerHTML =
        `<span style="color: var(--success-color);">‚úÖ PASS</span> - Test checkout created<br>
         Email: ${data.testEmail}<br>
         <small>Use 4242 4242 4242 4242 for testing</small><br>
         <small>Session: ${data.sessionId?.slice(0,20)}‚Ä¶</small>`;
      document.getElementById('test-email').value = data.testEmail;
    } catch (e) {
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL</span> - ${e.message}`;
    }
  }

  async function verifyEntitlement() {
    const email = document.getElementById('test-email').value;
    const detailsEl = document.getElementById('stripe-details');
    if (!email) { detailsEl.innerHTML += `<br><span style="color: var(--warning-color);">‚ö†Ô∏è Enter a test email first</span>`; return; }
    detailsEl.innerHTML += '<br><span class="loading-spinner"></span> Verifying entitlement...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch(`/.netlify/functions/admin-verify-entitlement?email=${encodeURIComponent(email)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Verification failed');

      const pass = data.test?.pass;
      detailsEl.innerHTML += `<br>${pass ? '<span style="color: var(--success-color);">‚úÖ PASS</span>' : '<span style="color: var(--error-color);">‚ùå FAIL</span>'} - Entitlement check
        <br>Profile: ${data.profile.provisioned ? 'Auto-provisioned' : 'Existing'}
        <br>Paid: ${data.profile.is_paid ? 'YES' : 'NO'}
        <br>Plan: ${data.profile.subscription_plan || 'None'}
        <br>Webhook: ${data.webhook.lastWebhookAt ? new Date(data.webhook.lastWebhookAt).toLocaleString() : 'None'}`;
    } catch (e) {
      detailsEl.innerHTML += `<br><span style="color: var(--error-color);">‚ùå FAIL</span> - ${e.message}`;
    }
  }

  // ---------------- Auth quick tests ----------------
  function openRegisterTest() {
    const testEmail = `admin+e2e-${Date.now()}@example.com`;
    window.open(`../register.html?prefill=${encodeURIComponent(testEmail)}`, '_blank');
  }
  function openLoginTest() {
    const testEmail = document.getElementById('test-email').value || 'admin+test@example.com';
    window.open(`../login.html?prefill=${encodeURIComponent(testEmail)}`, '_blank');
  }
  async function sessionEcho() {
    const el = document.getElementById('session-echo-result');
    el.innerHTML = '<span class="loading-spinner"></span> Checking session...';
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/session-echo', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      el.innerHTML = `<strong>Session Echo Result:</strong><br>Email: ${data.email || 'None'}<br>Entitled: ${data.entitled ? 'YES' : 'NO'}<br>Status: <span style="color: var(--success-color);">‚úÖ PASS</span>`;
    } catch (e) {
      el.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL - ${e.message}</span>`;
    }
  }

  // ---------------- AI smoke test ----------------
  async function runAISmokeTest() {
    const statusEl = document.getElementById('ai-status');
    const detailsEl = document.getElementById('ai-details');
    const resultEl = document.getElementById('ai-test-result');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Running AI smoke test...';
    resultEl.innerHTML = '';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-ai-smoke-test', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'AI smoke test failed');

      statusEl.className = 'status-indicator status-ok';
      detailsEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ PASS</span> - AI generation successful';
      resultEl.innerHTML = `
        <strong>Test Results:</strong><br>
        Tokens used: ${data.tokensUsed}<br>
        Output bytes: ${data.outputBytes}<br>
        Generation time: ${data.generationTimeMs}ms<br>
        Model: ${data.model}<br>
        Feedback ID: ${data.feedbackRowId || 'N/A'}<br>
        Preview: ${data.codePreview}
      `;
    } catch (e) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL</span> - AI test failed`;
      resultEl.innerHTML = `<span style="color: var(--error-color);">Error: ${e.message}</span>`;
    }
  }

  // ---------------- User stats ----------------
  async function loadUserStats() {
    const statusEl = document.getElementById('users-status');
    const detailsEl = document.getElementById('user-stats');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Loading user statistics...';

    try {
      const { data: profiles, error } = await supabaseClient
        .from('profiles')
        .select('subscription_plan, is_paid, is_active, created_at');
      if (error) throw error;

      const stats = {
        total: profiles.length,
        paid: profiles.filter(p => p.is_paid).length,
        active: profiles.filter(p => p.is_active).length,
        monthly: profiles.filter(p => p.subscription_plan === 'monthly').length,
        yearly: profiles.filter(p => p.subscription_plan === 'yearly').length
      };

      statusEl.className = 'status-indicator status-ok';
      detailsEl.innerHTML = `
        <div><strong>User Statistics:</strong></div>
        <div>Total users: ${stats.total}</div>
        <div>Paid users: ${stats.paid}</div>
        <div>Active users: ${stats.active}</div>
        <div>Monthly plans: ${stats.monthly}</div>
        <div>Yearly plans: ${stats.yearly}</div>
      `;
    } catch (e) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load stats: ${e.message}</span>`;
    }
  }

  // Phase 4.6.1: Load Recent Knowledge Usage
  async function loadRecentKnowledgeUsage() {
    const usageEl = document.getElementById('knowledge-usage');
    usageEl.innerHTML = '<span class="loading-spinner"></span> Loading recent knowledge pack usage...';

    try {
      // For now, show a placeholder - this would be enhanced to read from actual logs
      // In a production system, you'd track this in a database table
      const mockUsage = [
        {
          timestamp: new Date(Date.now() - 300000).toISOString(), // 5 min ago
          sessionId: 'session_' + Date.now(),
          assets: [
            'curated/global/approved.jsonl (2.1KB, curated-feedback)',
            'training-assets/2025/09/30/arduino-cases.jsonl (4.3KB, training-asset)'
          ]
        },
        {
          timestamp: new Date(Date.now() - 900000).toISOString(), // 15 min ago
          sessionId: 'session_' + (Date.now() - 900000),
          assets: [
            'curated/global/approved.jsonl (1.8KB, curated-feedback)'
          ]
        }
      ];

      if (mockUsage.length === 0) {
        usageEl.innerHTML = 'No recent knowledge pack usage in the last hour.';
        return;
      }

      let html = '<div><strong>Last 5 Knowledge Pack Uses:</strong></div>';
      mockUsage.forEach((usage, index) => {
        const timeAgo = Math.round((Date.now() - new Date(usage.timestamp).getTime()) / 60000);
        html += `
          <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--primary-bg); border-radius: 5px;">
            <div><strong>Session:</strong> ${usage.sessionId}</div>
            <div><strong>Time:</strong> ${timeAgo} minutes ago</div>
            <div><strong>Assets Used:</strong></div>
            <ul style="margin: 0.25rem 0 0 1rem; font-size: 0.9rem;">
              ${usage.assets.map(asset => `<li>${asset}</li>`).join('')}
            </ul>
          </div>
        `;
      });

      usageEl.innerHTML = html;
    } catch (error) {
      usageEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load knowledge usage: ${error.message}</span>`;
    }
  }

  // ---------------- Config (masked keys) ----------------
  let keysRevealed = false;
  function displayConfig() {
    const configEl = document.getElementById('config-display');
    const masked = (k) => (k ? k.slice(0, 20) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '');
    const safe = {
      APP_NAME: window.CONFIG.APP_NAME,
      VERSION: window.CONFIG.VERSION,
      PAYMENT_FIRST: window.CONFIG.PAYMENT_FIRST,
      FEATURES: window.CONFIG.FEATURES,
      PRICING: window.CONFIG.PRICING,
      SUPABASE_URL: window.CONFIG.SUPABASE_URL,
      STRIPE_PUBLISHABLE_KEY: keysRevealed ? window.CONFIG.STRIPE_PUBLISHABLE_KEY : masked(window.CONFIG.STRIPE_PUBLISHABLE_KEY),
      NETLIFY_FUNCTIONS_BASE: window.CONFIG.NETLIFY_FUNCTIONS_BASE
    };
    configEl.innerHTML = `<pre class="config-pre">${JSON.stringify(safe, null, 2)}</pre>`;
    const btn = document.getElementById('reveal-key-btn');
    if (window.CONFIG.STRIPE_PUBLISHABLE_KEY) {
      btn.classList.remove('hidden');
    } else {
      btn.classList.add('hidden');
    }
  }
  function toggleKeyVisibility() {
    keysRevealed = !keysRevealed;
    displayConfig();
    document.getElementById('reveal-key-btn').innerHTML = keysRevealed ? 'üôà Hide Keys' : 'üëÅÔ∏è Reveal Keys';
  }

  // ---------------- Feedback Review ----------------
  async function loadFeedbackReview() {
    const statusEl = document.getElementById('feedback-status');
    const listEl = document.getElementById('feedback-list');
    const status = document.getElementById('feedback-status-filter').value;
    const search = document.getElementById('feedback-search').value;

    statusEl.className = 'status-indicator status-unknown';
    listEl.innerHTML = '<span class="loading-spinner"></span> Loading feedback...';
    feedbackCache.clear();

    try {
      const session = await supabaseClient.auth.getSession();
      const token = session.data?.session?.access_token;

      const qs = new URLSearchParams({ status });
      if (search.trim()) {
        qs.append('search', search.trim());
      }

      const res = await fetch(`/.netlify/functions/admin-feedback-list?${qs.toString()}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      if (!res.ok || !data.ok || !Array.isArray(data.items)) {
        throw new Error(data.error || data.details || 'Failed to load feedback');
      }

      statusEl.className = 'status-indicator status-ok';

      if (data.items.length === 0) {
        listEl.innerHTML = `<div class="empty-state">No ${escapeHtml(status)} feedback found.</div>`;
        return;
      }

      const total = typeof data.total === 'number' ? data.total : data.items.length;
      const summary = document.createElement('div');
      summary.className = 'feedback-summary';
      summary.textContent = `Showing ${data.items.length} of ${total} feedback items`;

      const container = document.createElement('div');
      container.className = 'feedback-list';

      data.items.forEach(item => {
        feedbackCache.set(item.id, item);

        const card = document.createElement('article');
        card.className = 'feedback-card';
        card.dataset.feedbackId = item.id;

        const header = document.createElement('div');
        header.className = 'feedback-card-header';

        const author = document.createElement('div');
        author.className = 'feedback-author';
        author.textContent = item.user_email || 'Unknown';
        header.appendChild(author);

        const timestamp = document.createElement('div');
        timestamp.className = 'feedback-timestamp';
        timestamp.textContent = item.created_at ? new Date(item.created_at).toLocaleString() : '‚Äî';
        header.appendChild(timestamp);

        const quality = document.createElement('div');
        quality.className = 'feedback-quality';
        if (typeof item.quality_score === 'number') {
          const label = item.quality_label || (item.quality_score >= 4 ? 'High quality' : 'Needs review');
          quality.textContent = `Quality: ${item.quality_score}‚òÖ (${label})`;
        } else if (item.template) {
          quality.textContent = `Template: ${item.template}`;
        } else {
          quality.textContent = 'Template: general';
        }
        header.appendChild(quality);

        card.appendChild(header);

        const promptSnippet = document.createElement('div');
        promptSnippet.className = 'feedback-snippet';
        promptSnippet.innerHTML = `<strong>Prompt:</strong> ${escapeHtml(truncateText(item.design_prompt || '‚Äî', 160))}`;
        card.appendChild(promptSnippet);

        const feedbackSnippet = document.createElement('div');
        feedbackSnippet.className = 'feedback-snippet';
        feedbackSnippet.innerHTML = `<strong>Feedback:</strong> ${escapeHtml(truncateText(item.feedback_text || 'No feedback provided', 160))}`;
        card.appendChild(feedbackSnippet);

        const footer = document.createElement('div');
        footer.className = 'feedback-card-footer';

        const statusContainer = document.createElement('div');
        statusContainer.className = 'feedback-status';
        renderFeedbackStatus(statusContainer, item.review_status, item.reviewed_by);
        footer.appendChild(statusContainer);

        const actions = document.createElement('div');
        actions.className = 'feedback-actions';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-secondary btn-small';
        viewBtn.textContent = 'üëÅÔ∏è View Feedback';
        viewBtn.addEventListener('click', () => viewFeedback(item.id));
        actions.appendChild(viewBtn);

        if ((item.review_status || 'pending') === 'pending') {
          const acceptBtn = document.createElement('button');
          acceptBtn.className = 'btn btn-primary btn-small feedback-accept';
          acceptBtn.textContent = '‚úÖ Accept & Train';
          acceptBtn.addEventListener('click', () => decideFeedback(item.id, 'accept'));
          actions.appendChild(acceptBtn);

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'btn btn-secondary btn-small feedback-reject';
          rejectBtn.textContent = '‚ùå Reject';
          rejectBtn.addEventListener('click', () => confirmRejectFeedback(item.id));
          actions.appendChild(rejectBtn);
        } else {
          const statusLabel = document.createElement('span');
          statusLabel.className = 'feedback-reviewer';
          statusLabel.textContent = item.review_status === 'accepted' ? '‚úÖ Approved' : '‚ùå Rejected';
          actions.appendChild(statusLabel);
        }

        footer.appendChild(actions);
        card.appendChild(footer);

        container.appendChild(card);
      });

      listEl.innerHTML = '';
      listEl.appendChild(summary);
      listEl.appendChild(container);

    } catch (error) {
      statusEl.className = 'status-indicator status-error';
      listEl.innerHTML = `<span class="error-text">‚ùå Failed to load feedback: ${escapeHtml(error.message)}</span>`;
    }
  }

  async function decideFeedback(feedbackId, decision) {
  const row = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
  const acceptBtn = row?.querySelector('.feedback-accept');
  const rejectBtn = row?.querySelector('.feedback-reject');
    
    // Disable buttons during request
    if (acceptBtn) acceptBtn.disabled = true;
    if (rejectBtn) rejectBtn.disabled = true;

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-feedback-decide', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          feedback_id: feedbackId, 
          decision, 
          tags: decision === 'accept' ? ['admin-approved'] : null, 
          reason: `Admin ${decision} via console` 
        })
      });
      
      const data = await res.json();
      
      if (!data.ok) {
        const errorMsg = data.code ? `${data.code}: ${data.error}` : (data.error || data.details || `Failed to ${decision} feedback`);
        throw new Error(errorMsg);
      }

      // Update row UI in place (optimistic update)
      if (row) {
        const statusContainer = row.querySelector('.feedback-status');
        const actionsCell = row.querySelector('.feedback-actions');
        const newStatus = data.feedback?.review_status || (decision === 'accept' ? 'accepted' : 'rejected');
        const reviewedBy = data.feedback?.reviewed_by || 'admin';

        if (statusContainer) {
          renderFeedbackStatus(statusContainer, newStatus, reviewedBy);
        }
        
        if (actionsCell) {
          actionsCell.innerHTML = '';
          const statusLabel = document.createElement('span');
          statusLabel.className = 'feedback-reviewer';
          statusLabel.textContent = newStatus === 'accepted' ? '‚úÖ Approved' : '‚ùå Rejected';
          actionsCell.appendChild(statusLabel);
        }

        // Remove row from pending view after update
        const currentFilter = document.getElementById('feedback-status-filter').value;
        if (currentFilter === 'pending' && newStatus !== 'pending') {
          row.style.transition = 'opacity .3s ease-out';
          row.style.opacity = '0.5';
          setTimeout(() => row.remove(), 300);
        }

        const cached = feedbackCache.get(feedbackId);
        if (cached) {
          cached.review_status = newStatus;
          cached.reviewed_by = reviewedBy;
          cached.reviewed_at = data.feedback?.reviewed_at || cached.reviewed_at;
          feedbackCache.set(feedbackId, cached);
        }
      }

      const message = decision === 'accept' 
        ? 'Feedback accepted! Promoted to curated examples and added to training assets.'
        : 'Feedback rejected successfully.';
      showToast(message, 'success');
      
      // Refresh training assets list if we accepted feedback
      if (decision === 'accept') {
        setTimeout(() => loadTrainingAssets(), 500);
      }
      
    } catch (e) {
      // Re-enable buttons on error
      if (acceptBtn) acceptBtn.disabled = false;
      if (rejectBtn) rejectBtn.disabled = false;
      showToast(`Failed to ${decision} feedback: ${e.message}`, 'error');
    }
  }

  function showToast(message, type='info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed; top:20px; right:20px; padding:12px 20px;
      background: ${type==='success' ? 'var(--success-color)' : type==='error' ? 'var(--error-color)' : 'var(--primary)'};
      color:#fff; border-radius:4px; box-shadow:0 4px 12px rgba(0,0,0,.3);
      z-index:10000; font-size:14px; max-width:400px; transition:opacity .3s ease;`;
    toast.innerHTML = message; // Use innerHTML to support <br> tags
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); }, 3000);
  }

  // ---------------- Feedback Modal ----------------
  let currentModalFeedbackId = null;
  
  function viewFeedback(id) {
    const feedback = feedbackCache.get(id);
    if (!feedback) {
      showToast('Feedback details unavailable. Please reload the list.', 'error');
      return;
    }

    currentModalFeedbackId = id;

    const qualityMeta = [];
    if (typeof feedback.quality_score === 'number') {
      qualityMeta.push(`Quality: ${feedback.quality_score}‚òÖ`);
    }
    if (feedback.quality_label) {
      qualityMeta.push(`Label: ${feedback.quality_label}`);
    }
    if (feedback.template) {
      qualityMeta.push(`Template: ${feedback.template}`);
    }

    const modalHTML = `
      <div class="feedback-modal-content">
        <h3>Feedback Review - ID: ${escapeHtml(id)}</h3>
        ${qualityMeta.length ? `<div class="feedback-quality">${qualityMeta.map(escapeHtml).join(' ‚Ä¢ ')}</div>` : ''}
        <div class="feedback-modal-body">
          <section class="modal-section">
            <h4>Design Prompt</h4>
            <pre class="modal-pre">${escapeHtml(feedback.design_prompt || '‚Äî')}</pre>
          </section>
          <section class="modal-section">
            <h4>User Feedback</h4>
            <pre class="modal-pre">${escapeHtml(feedback.feedback_text || 'No feedback provided')}</pre>
          </section>
          <section class="modal-section">
            <h4>Generated Code</h4>
            <pre class="modal-pre">${escapeHtml(feedback.generated_code || 'No code returned')}</pre>
          </section>
        </div>
        <div class="modal-footer actions-right">
          <button class="btn btn-secondary modal-close-btn">Close</button>
          <button class="btn btn-success modal-accept-btn">‚úÖ Accept</button>
          <button class="btn btn-danger modal-reject-btn">‚ùå Reject</button>
        </div>
      </div>
    `;

    showModal(modalHTML);

    const modalRoot = document.getElementById('modal-root');
    modalRoot.querySelector('.modal-close-btn')?.addEventListener('click', hideModal);
    modalRoot.querySelector('.modal-accept-btn')?.addEventListener('click', () => {
      decideFeedback(id, 'accept');
      hideModal();
    });
    modalRoot.querySelector('.modal-reject-btn')?.addEventListener('click', () => {
      confirmRejectFeedback(id);
    });
  }
  
  function getCurrentModalFeedbackId() {
    return currentModalFeedbackId;
  }
  
  function confirmRejectFeedback(feedbackId) {
    if (confirm('Are you sure you want to reject this feedback?')) {
      hideModal();
      decideFeedback(feedbackId, 'reject');
    }
  }

  // ---------------- Knowledge Test ----------------
  async function runKnowledgeTest() {
    const resultsEl = document.getElementById('knowledge-results');
    const indicatorEl = document.getElementById('knowledge-indicator');
    const prompt = document.getElementById('knowledge-prompt').value;
    const template = document.getElementById('knowledge-template').value;
    
    indicatorEl.className = 'status-indicator status-unknown';
    resultsEl.style.display = 'none';
    
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-knowledge-test', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, template, maxExamples: 5 })
      });
      const data = await res.json();
      
      if (!data.ok) throw new Error(data.error || 'Knowledge test failed');
      
      // Update learning indicator
      const indicatorClass = data.learningIndicator === 'rich' ? 'status-ok' : 
                            data.learningIndicator === 'engaged' ? 'status-warning' : 'status-error';
      indicatorEl.className = `status-indicator ${indicatorClass}`;
      
      // Display results
      const pillClass = data.learningIndicator === 'rich' ? 'learning-rich' : 
                       data.learningIndicator === 'engaged' ? 'learning-engaged' : 'learning-none';
      
      document.getElementById('learning-indicator-display').innerHTML = 
        `<span class="learning-pill ${pillClass}">${data.learningIndicator.toUpperCase()}</span>
         Model: ${data.model}`;
      
      // Examples used
      if (data.used_examples?.length > 0) {
        const examplesHtml = data.used_examples.map(ex => 
          `<tr><td>${ex.id}</td><td>${ex.template || 'general'}</td><td>${(ex.tags || []).join(', ')}</td></tr>`
        ).join('');
        document.getElementById('knowledge-examples').innerHTML = 
          `<h4>Examples Used (${data.used_examples.length})</h4>
           <table class="admin-table">
             <tr><th>ID</th><th>Template</th><th>Tags</th></tr>
             ${examplesHtml}
           </table>`;
      } else {
        document.getElementById('knowledge-examples').innerHTML = '<h4>No examples used</h4>';
      }
      
      // Assets used
      if (data.assets_used?.length > 0) {
        const assetsHtml = data.assets_used.map(asset => 
          `<tr>
             <td>${asset.filename || asset.object_path}</td>
             <td>${asset.source}</td>
             <td>${asset.bytesUsed} bytes</td>
             <td>
               ${asset.object_path.endsWith('.jsonl') 
                 ? `<button onclick="previewJsonl('${encodeURIComponent(asset.object_path)}')" class="btn btn-secondary btn-small">üîé Preview</button>`
                 : ''
               }
             </td>
           </tr>`
        ).join('');
        document.getElementById('knowledge-assets').innerHTML = 
          `<h4>Assets Used (${data.assets_used.length})</h4>
           <table class="admin-table">
             <tr><th>File</th><th>Source</th><th>Bytes Used</th><th>Actions</th></tr>
             ${assetsHtml}
           </table>`;
      } else {
        document.getElementById('knowledge-assets').innerHTML = '<h4>No assets used</h4>';
      }
      
      // Debug log
      document.getElementById('knowledge-log-content').textContent = (data.log || []).join('\n');
      
      resultsEl.style.display = 'block';
      showToast(`Knowledge test complete: ${data.learningIndicator} learning level`, 'success');
      
    } catch (e) {
      indicatorEl.className = 'status-indicator status-error';
      showToast(`Knowledge test failed: ${e.message}`, 'error');
    }
  }

  // ---------------- Training Assets ----------------
  function escapeHtml(value = '') {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatBytes(bytes) {
    if (typeof bytes !== 'number' || Number.isNaN(bytes)) return '‚Äî';
    if (bytes === 0) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB'];
    const idx = Math.min(units.length - 1, Math.floor(Math.log(bytes) / Math.log(1024)));
    const value = bytes / Math.pow(1024, idx);
    const formatted = value >= 10 || idx === 0 ? value.toFixed(0) : value.toFixed(1);
    return `${formatted} ${units[idx]}`;
  }

  function renderAssetTags(tags) {
    if (!Array.isArray(tags) || !tags.length) {
      return '<span class="tag-pill tag-pill-empty">No tags</span>';
    }
    return tags
      .map(tag => `<span class="tag-pill">${escapeHtml(tag)}</span>`)
      .join('');
  }

  const feedbackCache = new Map();

  function truncateText(text = '', limit = 140) {
    if (!text) return '';
    return text.length > limit ? `${text.slice(0, limit)}‚Ä¶` : text;
  }

  function renderFeedbackStatus(container, status, reviewer) {
    const normalized = (status || 'pending').toLowerCase();
    container.innerHTML = '';

    const badge = document.createElement('span');
    badge.className = `status-badge ${normalized}`;
    badge.textContent = normalized.toUpperCase();
    container.appendChild(badge);

    if (reviewer) {
      const reviewerEl = document.createElement('div');
      reviewerEl.className = 'feedback-reviewer';
      reviewerEl.textContent = `by ${reviewer}`;
      container.appendChild(reviewerEl);
    }
  }

  async function loadTrainingAssets() {
    const listEl = document.getElementById('training-assets-list');
    if (!listEl) return;

    listEl.innerHTML = '<span class="loading-spinner"></span> Loading training assets...';

    try {
      const session = await supabaseClient.auth.getSession();
      const token = session.data?.session?.access_token;
      if (!token) throw new Error('Missing authentication token');

      const res = await fetch('/.netlify/functions/admin-list-training-assets', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        const errorMsg = data.error || data.message || res.statusText || 'Failed to load training assets';
        throw new Error(errorMsg);
      }

      const assets = data.assets ?? data.items ?? [];
      const totalCount = data.total ?? data.count ?? assets.length;

      if (!assets.length) {
        listEl.innerHTML = '<div class="empty-state">No training assets uploaded yet.</div>';
        return;
      }

      const container = document.createElement('div');
      container.className = 'training-assets-container';

      const summary = document.createElement('div');
      summary.className = 'training-assets-summary';
      summary.textContent = `Showing ${assets.length} of ${totalCount} assets`;
      const totalBytes = data.stats?.totalBytes ?? data.totalBytes;
      if (typeof totalBytes === 'number') {
        summary.textContent += ` ‚Ä¢ ${formatBytes(totalBytes)} total`;
      }
      container.appendChild(summary);

      const table = document.createElement('table');
      table.className = 'admin-table training-assets-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th scope="col">File</th>
            <th scope="col">Type</th>
            <th scope="col">Size</th>
            <th scope="col">Tags</th>
            <th scope="col">Source</th>
            <th scope="col">Created</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');

      assets.forEach(asset => {
        const tr = document.createElement('tr');
        const tags = Array.isArray(asset.tags) ? [...asset.tags] : [];
        const isCurated = asset.source === 'curated' || tags.includes('origin:curated-feedback');
        if (isCurated) {
          tr.classList.add('curated-row');
        }

        const fileCell = document.createElement('td');
        fileCell.innerHTML = `
          <div class="asset-name">${escapeHtml(asset.filename || asset.object_path || 'Unnamed asset')}</div>
          <div class="asset-path">${escapeHtml(asset.object_path || '')}</div>
        `;

        const typeCell = document.createElement('td');
        const assetType = (asset.asset_type || asset.assetType || '').toString().toLowerCase();
        typeCell.textContent = assetType ? assetType.toUpperCase() : '‚Äî';

        const sizeCell = document.createElement('td');
        sizeCell.textContent = formatBytes(asset.size_bytes ?? asset.size ?? 0);

        const tagsCell = document.createElement('td');
        tagsCell.innerHTML = renderAssetTags(tags);

        const sourceCell = document.createElement('td');
        const sourceLabel = isCurated ? 'Curated' : (asset.source || 'Admin Upload');
        sourceCell.innerHTML = `<span class="status-badge ${isCurated ? 'status-primary' : 'status-neutral'}">${escapeHtml(sourceLabel)}</span>`;

        const createdCell = document.createElement('td');
        const createdAt = asset.created_at || asset.inserted_at || asset.updated_at;
        createdCell.textContent = createdAt ? new Date(createdAt).toLocaleString() : '‚Äî';

        const actionsCell = document.createElement('td');
        actionsCell.className = 'asset-actions';

        if (assetType === 'jsonl' || (asset.object_path || '').endsWith('.jsonl')) {
          const previewBtn = document.createElement('button');
          previewBtn.className = 'btn btn-secondary btn-small';
          previewBtn.textContent = 'üîé Preview';
          previewBtn.addEventListener('click', () => previewJsonl(asset.object_path));
          actionsCell.appendChild(previewBtn);
        } else if (asset.url) {
          const viewLink = document.createElement('a');
          viewLink.className = 'btn btn-secondary btn-small';
          viewLink.textContent = 'ÔøΩÔ∏è View';
          viewLink.href = asset.url;
          viewLink.target = '_blank';
          viewLink.rel = 'noopener';
          actionsCell.appendChild(viewLink);
        }

        const downloadUrl = asset.download_url || asset.signed_url || asset.url;
        if (downloadUrl) {
          const downloadBtn = document.createElement('a');
          downloadBtn.className = 'btn btn-secondary btn-small';
          downloadBtn.textContent = '‚¨áÔ∏è Download';
          downloadBtn.href = downloadUrl;
          downloadBtn.target = '_blank';
          downloadBtn.rel = 'noopener';
          actionsCell.appendChild(downloadBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-secondary btn-small';
        deleteBtn.textContent = 'üóëÔ∏è Delete';
        if (isCurated || !asset.id) {
          deleteBtn.disabled = true;
          deleteBtn.title = 'Curated assets cannot be deleted from this panel';
        } else {
          deleteBtn.addEventListener('click', () => deleteTrainingAsset(asset.id, { filename: asset.filename }));
        }
        actionsCell.appendChild(deleteBtn);

        tr.append(fileCell, typeCell, sizeCell, tagsCell, sourceCell, createdCell, actionsCell);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);

      if (data.nextCursor || data.pagination?.hasMore) {
        const notice = document.createElement('div');
        notice.className = 'training-assets-pagination';
        notice.textContent = 'More assets are available; use Supabase pagination to explore further.';
        container.appendChild(notice);
      }

      listEl.innerHTML = '';
      listEl.appendChild(container);
    } catch (error) {
      console.error('Failed to load training assets', error);
      listEl.innerHTML = `<span class="error-text">‚ùå Failed to load assets: ${escapeHtml(error.message)}</span>`;
    }
  }

  async function uploadTrainingAsset() {
    const input = document.getElementById('asset-file-input');
    const file = input.files[0];
    if (!file) { alert('Select a file to upload'); return; }

    const allowed = ['.svg','.scad','.jsonl'];
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) { alert(`Invalid file type. Allowed: ${allowed.join(', ')}`); return; }

    const listEl = document.getElementById('training-assets-list');
    listEl.innerHTML = '<span class="loading-spinner"></span> Uploading training asset...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;

      // 1) Create signed upload
      const createRes = await fetch('/.netlify/functions/admin-create-signed-upload', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: file.name,
          contentType: file.type || 'application/octet-stream',
          size: file.size,
          assetType: ext.slice(1), // svg|scad|jsonl
          tags: []
        })
      });
      const createData = await createRes.json();
      if (!createData.ok) throw new Error(createData.error || 'Failed to create signed upload URL');

      // 2) Upload directly to storage
      const upload = await supabaseClient.storage
        .from(createData.bucket)
        .uploadToSignedUrl(createData.object_path, createData.token, file, { contentType: file.type || 'application/octet-stream' });
      if (upload.error) throw new Error(`Upload to storage failed: ${upload.error.message}`);

      // 3) Commit metadata (server validates JSONL sample if needed)
      const commitRes = await fetch('/.netlify/functions/admin-commit-training-asset', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          object_path: createData.object_path,
          assetType: createData.assetType,   // <‚Äî ensure this line exists
          filename: file.name,
          size: file.size,
          contentType: file.type || 'application/octet-stream',
          tags: []
        })
      });
      const commitData = await commitRes.json();
      
      // --- BEGIN PATCH: commitData handling (Upload Training Asset) ---
      if (commitData.ok) {
        const msg = commitData.sampleValidated
          ? `Upload successful! Validated ${commitData.sampleCount} JSONL lines.`
          : 'Asset uploaded successfully!';
        showToast(msg, 'success');
        input.value = '';
        await loadTrainingAssets();
      } else {
        if (commitData.code === 'invalid_jsonl') {
          const where = commitData.lineNumber ? ` on line ${commitData.lineNumber}` : '';
          const snippet = commitData.snippet ? `\nSnippet: ${commitData.snippet}` : '';
          showToast(`JSONL validation failed${where}: ${commitData.error || 'Parse error'}${snippet}`, 'error');
        } else {
          showToast(`Upload failed: ${commitData.error || 'Unknown error'}`, 'error');
        }
      }
      // --- END PATCH ---
    } catch (e) {
      console.error('Upload error:', e);
      const msg = e.message.includes('<br>') ? e.message : `‚ùå Upload failed: ${e.message}`;
      document.getElementById('training-assets-list').innerHTML = `<span style="color: var(--error-color);">${msg}</span>`;
      if (e.message.includes('JSONL validation')) showToast('JSONL file validation failed. Check details.', 'error');
    }
  }

  async function previewJsonl(objectPath) {
    if (!objectPath) {
      showToast('Preview failed: missing object path.', 'error');
      return;
    }

    try {
      const session = await supabaseClient.auth.getSession();
      const token = session.data?.session?.access_token;
      if (!token) throw new Error('Missing authentication token');

      const params = new URLSearchParams({ object_path: objectPath, limit: '25' });
      const res = await fetch(`/.netlify/functions/admin-jsonl-preview?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        if (data.code === 'invalid_jsonl') {
          showToast(`JSONL validation failed: ${data.error}`, 'error');
          return;
        }
        const reason = data.error || res.statusText || 'Preview failed';
        throw new Error(reason);
      }

      const lines = data.lines || [];
      const metaParts = [
        `<strong>Sample Size:</strong> ${formatBytes(data.sampleSizeBytes || 0)}`,
        data.assetSizeBytes ? `<strong>Total Size:</strong> ${formatBytes(data.assetSizeBytes)}` : '',
        data.truncated ? '<strong>Note:</strong> Preview truncated to first 64KB' : ''
      ].filter(Boolean);

      const previewHtml = lines.length
        ? lines.map(entry => {
            if (entry.error) {
              return `
                <div class="jsonl-line jsonl-line-error">
                  <div class="jsonl-line-number">#${entry.lineNumber}</div>
                  <div class="jsonl-line-content">
                    <div class="jsonl-error-message">Parse error: ${escapeHtml(entry.error)}</div>
                    <pre>${escapeHtml(entry.raw || '')}</pre>
                  </div>
                </div>
              `;
            }

            const keys = Array.isArray(entry.keys) && entry.keys.length
              ? `<div class="jsonl-keys">${entry.keys.map(key => `<span class="tag-pill">${escapeHtml(key)}</span>`).join('')}</div>`
              : '';

            const prettyJson = escapeHtml(JSON.stringify(entry.json, null, 2));
            return `
              <div class="jsonl-line">
                <div class="jsonl-line-number">#${entry.lineNumber}</div>
                <div class="jsonl-line-content">
                  ${keys}
                  <pre>${prettyJson}</pre>
                </div>
              </div>
            `;
          }).join('')
        : '<div class="empty-state">No JSON lines found in preview.</div>';

      const modalHTML = `
        <div class="jsonl-preview-modal">
          <h3>JSONL Preview</h3>
          <div class="preview-meta">${metaParts.join(' ‚Ä¢ ') || 'No additional metadata available.'}</div>
          <div class="preview-content">${previewHtml}</div>
          <div class="modal-footer actions-right">
            <button class="btn btn-secondary" onclick="hideModal()">Close</button>
          </div>
        </div>
      `;

      showModal(modalHTML);
    } catch (error) {
      console.error('JSONL preview failed:', error);
      showToast(`Preview failed: ${error.message}`, 'error');
    }
  }

  async function deleteTrainingAsset(id, meta = {}) {
    if (!id) {
      showToast('Curated assets cannot be deleted from this panel.', 'info');
      return;
    }

    const label = meta.filename ? ` "${meta.filename}"` : '';
    if (!confirm(`Delete training asset${label}? This cannot be undone.`)) return;

    try {
      const session = await supabaseClient.auth.getSession();
      const token = session.data?.session?.access_token;
      if (!token) throw new Error('Missing authentication token');

      const res = await fetch('/.netlify/functions/admin-delete-training-asset', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        const errorMsg = data.error || res.statusText || 'Delete failed';
        throw new Error(errorMsg);
      }

      showToast('Training asset deleted.', 'success');
      await loadTrainingAssets();
    } catch (error) {
      console.error('Delete training asset failed:', error);
      showToast(`Failed to delete asset: ${error.message}`, 'error');
    }
  }

  // ---------------- Logout ----------------
  function handleLogout() { window.flexicadAuth.logout(); }
</script>

<!-- Modal Root for Phase 4.6 -->
<div id="modal-root" class="modal-root" hidden>
  <div class="modal-backdrop"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <button class="modal-close" aria-label="Close">√ó</button>
    <div class="modal-content"></div>
  </div>
</div>

<script type="module" src="../js/modals.js" defer></script>
</body>
</html>