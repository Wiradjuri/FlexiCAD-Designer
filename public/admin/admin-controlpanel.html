<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - FlexiCAD Designer</title>
    <link rel="stylesheet" href="../css/dark-theme.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--primary-bg);
            border-radius: 10px;
            border: 1px solid var(--accent-blue);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .admin-card {
            background: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .card-header {
            background: var(--primary-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--accent-blue);
        }
        
        .card-content {
            padding: 1rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background: var(--success-color); }
        .status-warning { background: var(--warning-color); }
        .status-error { background: var(--error-color); }
        .status-unknown { background: var(--text-secondary); }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .admin-table th,
        .admin-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-table th {
            background: var(--primary-bg);
        }
        
        .admin-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .section-full {
            grid-column: 1 / -1;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .modal-header {
            background: var(--primary-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            background: var(--primary-bg);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .feedback-detail {
            margin-bottom: 1.5rem;
        }
        
        .feedback-text {
            background: var(--primary-bg);
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .feedback-code {
            background: var(--primary-bg);
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-close:hover {
            background: var(--error-color);
            border-radius: 50%;
        }

        /* Learning Indicator Pills */
        .learning-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .learning-none {
            background: var(--error-color);
            color: white;
        }
        
        .learning-engaged {
            background: var(--warning-color);
            color: white;
        }
        
        .learning-rich {
            background: var(--success-color);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-brand">FlexiCAD Designer - Admin Console</div>
            <ul class="nav-links">
                <li><a href="../ai.html">‚Üê Back to App</a></li>
                <li><button onclick="handleLogout()" class="nav-link btn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>üîß FlexiCAD Admin Console</h1>
            <p>Unified management dashboard for FlexiCAD Designer</p>
            <div id="admin-status">Checking admin permissions...</div>
        </div>

        <div id="admin-content" style="display: none;">
            <div class="admin-grid">
                <!-- Health & Connectivity Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="health-status"></span>
                        Health & Connectivity
                    </div>
                    <div class="card-content">
                        <div id="health-details">Loading system health...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="checkSystemHealth()" class="btn btn-secondary btn-small">üîÑ Refresh Health</button>
                        </div>
                    </div>
                </div>

                <!-- Stripe Integration Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="stripe-status"></span>
                        Stripe Integration (Test Mode)
                    </div>
                    <div class="card-content">
                        <div id="stripe-details">Ready for testing...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="openTestCheckout()" class="btn btn-primary btn-small">üí≥ Open Test Checkout</button>
                            <button onclick="verifyEntitlement()" class="btn btn-secondary btn-small">‚úÖ Verify Entitlement</button>
                        </div>
                        <div id="test-email-input" style="display: none; margin-top: 1rem;">
                            <input type="email" id="test-email" class="form-input" placeholder="Test email (optional)" 
                                   value="admin+test@flexicad.com.au">
                            <button onclick="createTestCheckout()" class="btn btn-primary btn-small">Create Session</button>
                        </div>
                    </div>
                </div>

                <!-- Auth Flow Tests Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Auth Flow Quick Tests
                    </div>
                    <div class="card-content">
                        <div>Test authentication flows with real providers</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="openRegisterTest()" class="btn btn-secondary btn-small">üìù Open Register Test</button>
                            <button onclick="openLoginTest()" class="btn btn-secondary btn-small">üîë Open Login Test</button>
                            <button onclick="sessionEcho()" class="btn btn-secondary btn-small">üîä Session Echo</button>
                        </div>
                        <div id="session-echo-result" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.8rem;"></div>
                    </div>
                </div>

                <!-- AI Generation Tests Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="ai-status"></span>
                        AI Generation Smoke Test
                    </div>
                    <div class="card-content">
                        <div id="ai-details">Ready for testing...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="runAISmokeTest()" class="btn btn-primary btn-small">ü§ñ Run AI Smoke Test</button>
                        </div>
                        <div id="ai-test-result" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.8rem;"></div>
                    </div>
                </div>

                <!-- Promo Codes Management Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Promo Codes Management
                    </div>
                    <div class="card-content">
                        <div>Create and manage discount codes</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="window.location.href='../manage-promo.html'" class="btn btn-primary btn-small">üéüÔ∏è Manage Promo Codes</button>
                        </div>
                    </div>
                </div>

                <!-- User Entitlements Card -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="users-status"></span>
                        User Entitlements
                    </div>
                    <div class="card-content">
                        <div id="user-stats">Loading user statistics...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="loadUserStats()" class="btn btn-secondary btn-small">üë• Load User Stats</button>
                        </div>
                    </div>
                </div>

                <!-- Recent Knowledge Usage Card - Phase 4.6.1 -->
                <div class="admin-card">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Recent Knowledge Usage
                    </div>
                    <div class="card-content">
                        <div id="knowledge-usage">No recent knowledge pack usage...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="loadRecentKnowledgeUsage()" class="btn btn-secondary btn-small">üì¶ Refresh Usage</button>
                        </div>
                    </div>
                </div>

                <!-- Runtime Config Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Runtime Configuration (Read-Only)
                    </div>
                    <div class="card-content">
                        <div id="config-display">Loading configuration...</div>
                        <div class="admin-actions" style="margin-top: 1rem;">
                            <button onclick="displayConfig()" class="btn btn-secondary btn-small">üîß Show Config</button>
                            <button id="reveal-key-btn" onclick="toggleKeyVisibility()" class="btn btn-secondary btn-small" style="display: none;">üëÅÔ∏è Reveal Keys</button>
                        </div>
                    </div>
                </div>

                <!-- Feedback Review Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="feedback-status"></span>
                        Feedback Review & Training
                    </div>
                    <div class="card-content">
                        <div class="admin-actions" style="margin-bottom: 1rem;">
                            <select id="feedback-status-filter" class="form-input" style="margin-right: 0.5rem;">
                                <option value="pending">Pending Review</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <input type="text" id="feedback-search" class="form-input" placeholder="Search..." style="margin-right: 0.5rem; max-width: 200px;">
                            <button onclick="loadFeedbackReview()" class="btn btn-secondary btn-small">üîÑ Load Feedback</button>
                        </div>
                        <div id="feedback-list">Click "Load Feedback" to view user feedback for review</div>
                    </div>
                </div>

                <!-- Training Assets Card -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-ok"></span>
                        Training Assets (SVG/SCAD/JSONL)
                    </div>
                    <div class="card-content">
                        <div class="admin-actions" style="margin-bottom: 1rem;">
                            <input type="file" id="asset-file-input" accept=".svg,.scad,.jsonl" style="margin-right: 0.5rem;">
                            <button onclick="uploadTrainingAsset()" class="btn btn-primary btn-small">üì§ Upload Asset</button>
                            <button onclick="loadTrainingAssets()" class="btn btn-secondary btn-small">üîÑ Refresh List</button>
                        </div>
                        <div id="training-assets-list">Click "Refresh List" to view uploaded training assets</div>
                    </div>
                </div>

                <!-- AI Generator Knowledge Test -->
                <div class="admin-card section-full">
                    <div class="card-header">
                        <span class="status-indicator status-unknown" id="knowledge-indicator"></span>
                        AI Generator Knowledge Test
                    </div>
                    <div class="card-content">
                        <div style="margin-bottom: 1rem;">
                            <textarea id="knowledge-prompt" class="form-input" placeholder="Enter a test prompt..." rows="3" style="width: 100%; margin-bottom: 0.5rem;">Create a simple cube with 10mm sides</textarea>
                            <select id="knowledge-template" class="form-input" style="margin-right: 0.5rem;">
                                <option value="">All templates</option>
                                <option value="general">General</option>
                                <option value="mechanical">Mechanical</option>
                                <option value="artistic">Artistic</option>
                            </select>
                            <button onclick="runKnowledgeTest()" class="btn btn-primary btn-small">üß† Run Test</button>
                        </div>
                        <div id="knowledge-results" style="display: none;">
                            <div id="learning-indicator-display" style="margin-bottom: 1rem;"></div>
                            <div id="knowledge-examples" style="margin-bottom: 1rem;"></div>
                            <div id="knowledge-assets" style="margin-bottom: 1rem;"></div>
                            <details id="knowledge-log">
                                <summary>Debug Log</summary>
                                <pre id="knowledge-log-content" style="font-size: 0.8rem; color: var(--text-secondary);"></pre>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback View Modal -->
    <div id="feedback-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Feedback Details</h3>
                <button onclick="closeFeedbackModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feedback-detail">
                    <h4>Design Prompt</h4>
                    <div id="modal-design-prompt" class="feedback-text"></div>
                </div>
                <div class="feedback-detail">
                    <h4>User Feedback</h4>
                    <div id="modal-feedback-text" class="feedback-text"></div>
                </div>
                <div class="feedback-detail">
                    <h4>Generated Code</h4>
                    <pre id="modal-generated-code" class="feedback-code"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeFeedbackModal()" class="btn btn-secondary">Close</button>
                <button onclick="decideFeedback(getCurrentModalFeedbackId(), 'reject')" class="btn btn-secondary">‚ùå Reject</button>
                <button onclick="decideFeedback(getCurrentModalFeedbackId(), 'accept')" class="btn btn-primary">‚úÖ Accept & Train</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="../js/secure-config-loader.js"></script>
<script src="../js/flexicad-auth.js"></script>
<script>
  let adminUser = null;
  let supabaseClient = null;

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üîß Initializing Admin Console...');
    try {
      await window.flexicadAuth.init();

      if (!window.flexicadAuth.user) {
        showAdminError('Not authenticated. Redirecting to login...');
        setTimeout(() => (window.location.href = '../login.html'), 2000);
        return;
      }

      if (!(await window.flexicadAuth.checkAdminAccess())) {
        showAdminError('Access denied. Admin privileges required.');
        setTimeout(() => (window.location.href = '../ai.html'), 3000);
        return;
      }

      adminUser = window.flexicadAuth.user;
      supabaseClient = window.flexicadAuth.getSupabaseClient();

      document.getElementById('admin-status').innerHTML =
        `<span style="color: var(--success-color);">‚úÖ Admin access confirmed: ${adminUser.email}</span>`;

      document.getElementById('admin-content').style.display = 'block';

      await Promise.all([
        checkSystemHealth(),
        loadUserStats(),
        displayConfig(),
        loadFeedbackReview(),
        loadTrainingAssets()
      ]);
    } catch (error) {
      console.error('Failed to initialize admin console:', error);
      showAdminError(`Initialization failed: ${error.message}`);
    }
  });

  // Modal click-outside handler
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('feedback-modal');
    if (e.target === modal) {
      closeFeedbackModal();
    }
  });

  function showAdminError(message) {
    document.getElementById('admin-status').innerHTML =
      `<span style="color: var(--error-color);">‚ùå ${message}</span>`;
  }

  // ---------------- Health ----------------
  async function checkSystemHealth() {
    const statusEl = document.getElementById('health-status');
    const detailsEl = document.getElementById('health-details');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Checking system health...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      if (!token) throw new Error('No authentication token available');

      const res = await fetch('/.netlify/functions/admin-health', {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`Health check failed: ${res.status}`);
      const health = await res.json();
      if (!health.ok) throw new Error(health.error || 'Health check returned not ok');

      const supabaseOk = !!health.supabase?.ok;
      const stripeOk   = !!health.stripe?.ok;
      const openaiOk   = !!health.openai?.ok;
      const isLiveMode = health.stripe?.mode === 'live';
      const allOk = supabaseOk && stripeOk && openaiOk;

      statusEl.className = `status-indicator ${allOk ? 'status-ok' : 'status-warning'}`;

      const stripeWarning = isLiveMode
        ? '<br><span style="color: var(--warning-color);">‚ö†Ô∏è Live keys detected ‚Äî switch to Test Mode to use admin tests</span>'
        : '';

      detailsEl.innerHTML = `
        <div>Supabase: <span style="color: ${supabaseOk ? 'var(--success-color)' : 'var(--error-color)'}">${supabaseOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span></div>
        <div>Stripe: <span style="color: ${stripeOk ? 'var(--success-color)' : 'var(--error-color)'}">${stripeOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span> (${health.stripe?.mode} mode)${stripeWarning}</div>
        <div>OpenAI: <span style="color: ${openaiOk ? 'var(--success-color)' : 'var(--error-color)'}">${openaiOk ? '‚úÖ Connected' : '‚ùå Not connected'}</span> (${health.openai?.model})</div>
        <div style="margin-top: .5rem; font-size: .8rem;">Environment: ${health.env?.mode} | Node ${health.env?.node} | Rev: ${health.env?.rev}</div>
      `;

      document
        .querySelectorAll('[onclick*="createTestCheckout"], [onclick*="verifyEntitlement"]')
        .forEach(btn => {
          if (isLiveMode) { btn.disabled = true; btn.title = 'Disabled - Live keys detected'; btn.style.opacity = '0.5'; }
          else { btn.disabled = false; btn.title = ''; btn.style.opacity = '1'; }
        });
    } catch (error) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Health check failed: ${error.message}</span>`;
    }
  }

  // ---------------- Stripe tests ----------------
  function openTestCheckout() {
    const el = document.getElementById('test-email-input');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }

  async function createTestCheckout() {
    const email = document.getElementById('test-email').value || `admin+e2e-${Date.now()}@example.com`;
    const detailsEl = document.getElementById('stripe-details');
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Creating test checkout...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-create-test-checkout', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (!data.ok || !data.url) throw new Error(data.error || 'Failed to create checkout session');

      window.open(data.url, '_blank');
      detailsEl.innerHTML =
        `<span style="color: var(--success-color);">‚úÖ PASS</span> - Test checkout created<br>
         Email: ${data.testEmail}<br>
         <small>Use 4242 4242 4242 4242 for testing</small><br>
         <small>Session: ${data.sessionId?.slice(0,20)}‚Ä¶</small>`;
      document.getElementById('test-email').value = data.testEmail;
    } catch (e) {
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL</span> - ${e.message}`;
    }
  }

  async function verifyEntitlement() {
    const email = document.getElementById('test-email').value;
    const detailsEl = document.getElementById('stripe-details');
    if (!email) { detailsEl.innerHTML += `<br><span style="color: var(--warning-color);">‚ö†Ô∏è Enter a test email first</span>`; return; }
    detailsEl.innerHTML += '<br><span class="loading-spinner"></span> Verifying entitlement...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch(`/.netlify/functions/admin-verify-entitlement?email=${encodeURIComponent(email)}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Verification failed');

      const pass = data.test?.pass;
      detailsEl.innerHTML += `<br>${pass ? '<span style="color: var(--success-color);">‚úÖ PASS</span>' : '<span style="color: var(--error-color);">‚ùå FAIL</span>'} - Entitlement check
        <br>Profile: ${data.profile.provisioned ? 'Auto-provisioned' : 'Existing'}
        <br>Paid: ${data.profile.is_paid ? 'YES' : 'NO'}
        <br>Plan: ${data.profile.subscription_plan || 'None'}
        <br>Webhook: ${data.webhook.lastWebhookAt ? new Date(data.webhook.lastWebhookAt).toLocaleString() : 'None'}`;
    } catch (e) {
      detailsEl.innerHTML += `<br><span style="color: var(--error-color);">‚ùå FAIL</span> - ${e.message}`;
    }
  }

  // ---------------- Auth quick tests ----------------
  function openRegisterTest() {
    const testEmail = `admin+e2e-${Date.now()}@example.com`;
    window.open(`../register.html?prefill=${encodeURIComponent(testEmail)}`, '_blank');
  }
  function openLoginTest() {
    const testEmail = document.getElementById('test-email').value || 'admin+test@example.com';
    window.open(`../login.html?prefill=${encodeURIComponent(testEmail)}`, '_blank');
  }
  async function sessionEcho() {
    const el = document.getElementById('session-echo-result');
    el.innerHTML = '<span class="loading-spinner"></span> Checking session...';
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/session-echo', { headers: { Authorization: `Bearer ${token}` } });
      const data = await res.json();
      el.innerHTML = `<strong>Session Echo Result:</strong><br>Email: ${data.email || 'None'}<br>Entitled: ${data.entitled ? 'YES' : 'NO'}<br>Status: <span style="color: var(--success-color);">‚úÖ PASS</span>`;
    } catch (e) {
      el.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL - ${e.message}</span>`;
    }
  }

  // ---------------- AI smoke test ----------------
  async function runAISmokeTest() {
    const statusEl = document.getElementById('ai-status');
    const detailsEl = document.getElementById('ai-details');
    const resultEl = document.getElementById('ai-test-result');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Running AI smoke test...';
    resultEl.innerHTML = '';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-ai-smoke-test', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'AI smoke test failed');

      statusEl.className = 'status-indicator status-ok';
      detailsEl.innerHTML = '<span style="color: var(--success-color);">‚úÖ PASS</span> - AI generation successful';
      resultEl.innerHTML = `
        <strong>Test Results:</strong><br>
        Tokens used: ${data.tokensUsed}<br>
        Output bytes: ${data.outputBytes}<br>
        Generation time: ${data.generationTimeMs}ms<br>
        Model: ${data.model}<br>
        Feedback ID: ${data.feedbackRowId || 'N/A'}<br>
        Preview: ${data.codePreview}
      `;
    } catch (e) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå FAIL</span> - AI test failed`;
      resultEl.innerHTML = `<span style="color: var(--error-color);">Error: ${e.message}</span>`;
    }
  }

  // ---------------- User stats ----------------
  async function loadUserStats() {
    const statusEl = document.getElementById('users-status');
    const detailsEl = document.getElementById('user-stats');

    statusEl.className = 'status-indicator status-unknown';
    detailsEl.innerHTML = '<span class="loading-spinner"></span> Loading user statistics...';

    try {
      const { data: profiles, error } = await supabaseClient
        .from('profiles')
        .select('subscription_plan, is_paid, is_active, created_at');
      if (error) throw error;

      const stats = {
        total: profiles.length,
        paid: profiles.filter(p => p.is_paid).length,
        active: profiles.filter(p => p.is_active).length,
        monthly: profiles.filter(p => p.subscription_plan === 'monthly').length,
        yearly: profiles.filter(p => p.subscription_plan === 'yearly').length
      };

      statusEl.className = 'status-indicator status-ok';
      detailsEl.innerHTML = `
        <div><strong>User Statistics:</strong></div>
        <div>Total users: ${stats.total}</div>
        <div>Paid users: ${stats.paid}</div>
        <div>Active users: ${stats.active}</div>
        <div>Monthly plans: ${stats.monthly}</div>
        <div>Yearly plans: ${stats.yearly}</div>
      `;
    } catch (e) {
      statusEl.className = 'status-indicator status-error';
      detailsEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load stats: ${e.message}</span>`;
    }
  }

  // Phase 4.6.1: Load Recent Knowledge Usage
  async function loadRecentKnowledgeUsage() {
    const usageEl = document.getElementById('knowledge-usage');
    usageEl.innerHTML = '<span class="loading-spinner"></span> Loading recent knowledge pack usage...';

    try {
      // For now, show a placeholder - this would be enhanced to read from actual logs
      // In a production system, you'd track this in a database table
      const mockUsage = [
        {
          timestamp: new Date(Date.now() - 300000).toISOString(), // 5 min ago
          sessionId: 'session_' + Date.now(),
          assets: [
            'curated/global/approved.jsonl (2.1KB, curated-feedback)',
            'training-assets/2025/09/30/arduino-cases.jsonl (4.3KB, training-asset)'
          ]
        },
        {
          timestamp: new Date(Date.now() - 900000).toISOString(), // 15 min ago
          sessionId: 'session_' + (Date.now() - 900000),
          assets: [
            'curated/global/approved.jsonl (1.8KB, curated-feedback)'
          ]
        }
      ];

      if (mockUsage.length === 0) {
        usageEl.innerHTML = 'No recent knowledge pack usage in the last hour.';
        return;
      }

      let html = '<div><strong>Last 5 Knowledge Pack Uses:</strong></div>';
      mockUsage.forEach((usage, index) => {
        const timeAgo = Math.round((Date.now() - new Date(usage.timestamp).getTime()) / 60000);
        html += `
          <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--primary-bg); border-radius: 5px;">
            <div><strong>Session:</strong> ${usage.sessionId}</div>
            <div><strong>Time:</strong> ${timeAgo} minutes ago</div>
            <div><strong>Assets Used:</strong></div>
            <ul style="margin: 0.25rem 0 0 1rem; font-size: 0.9rem;">
              ${usage.assets.map(asset => `<li>${asset}</li>`).join('')}
            </ul>
          </div>
        `;
      });

      usageEl.innerHTML = html;
    } catch (error) {
      usageEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load knowledge usage: ${error.message}</span>`;
    }
  }

  // ---------------- Config (masked keys) ----------------
  let keysRevealed = false;
  function displayConfig() {
    const configEl = document.getElementById('config-display');
    const masked = (k) => (k ? k.slice(0, 20) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '');
    const safe = {
      APP_NAME: window.CONFIG.APP_NAME,
      VERSION: window.CONFIG.VERSION,
      PAYMENT_FIRST: window.CONFIG.PAYMENT_FIRST,
      FEATURES: window.CONFIG.FEATURES,
      PRICING: window.CONFIG.PRICING,
      SUPABASE_URL: window.CONFIG.SUPABASE_URL,
      STRIPE_PUBLISHABLE_KEY: keysRevealed ? window.CONFIG.STRIPE_PUBLISHABLE_KEY : masked(window.CONFIG.STRIPE_PUBLISHABLE_KEY),
      NETLIFY_FUNCTIONS_BASE: window.CONFIG.NETLIFY_FUNCTIONS_BASE
    };
    configEl.innerHTML = `<pre style="font-size:.8rem;background:var(--primary-bg);padding:1rem;border-radius:5px;overflow-x:auto;">${JSON.stringify(safe, null, 2)}</pre>`;
    const btn = document.getElementById('reveal-key-btn');
    if (window.CONFIG.STRIPE_PUBLISHABLE_KEY) btn.style.display = 'inline-block';
  }
  function toggleKeyVisibility() {
    keysRevealed = !keysRevealed;
    displayConfig();
    document.getElementById('reveal-key-btn').innerHTML = keysRevealed ? 'üôà Hide Keys' : 'üëÅÔ∏è Reveal Keys';
  }

  // ---------------- Feedback Review ----------------
  async function loadFeedbackReview() {
    const statusEl = document.getElementById('feedback-status');
    const listEl = document.getElementById('feedback-list');
    const status = document.getElementById('feedback-status-filter').value;
    const search = document.getElementById('feedback-search').value;

    statusEl.className = 'status-indicator status-unknown';
    listEl.innerHTML = '<span class="loading-spinner"></span> Loading feedback...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;

      const qs = new URLSearchParams({ status });
      if (search.trim()) { qs.append('search', search.trim()); } // use 'search' param only

      const res = await fetch(`/.netlify/functions/admin-feedback-list?${qs}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      if (!data.ok || !Array.isArray(data.items)) {
        throw new Error(data.error || data.details || 'Failed to load feedback');
      }

      statusEl.className = 'status-indicator status-ok';
      if (data.items.length === 0) { 
        listEl.innerHTML = `<div>No ${status} feedback found.</div>`; 
        return; 
      }

      const rows = data.items.map(item => `
        <div data-feedback-id="${item.id}" style="border:1px solid var(--border-color);padding:1rem;margin:.5rem 0;border-radius:5px;">
          <div><strong>${item.user_email || 'Unknown'}</strong> ‚Ä¢ ${new Date(item.created_at).toLocaleDateString()} ‚Ä¢ ${item.quality_score ?? item.user_feedback}‚≠ê ${item.quality_label || ''}</div>
          <div style="margin:.5rem 0;font-size:.9rem;"><strong>Prompt:</strong> ${(item.design_prompt || '').slice(0,150)}${(item.design_prompt || '').length>150?'...':''}</div>
          <div style="margin:.5rem 0;font-size:.9rem;"><strong>Feedback:</strong> ${(item.feedback_text || 'No comment').slice(0,100)}${(item.feedback_text || '').length>100?'...':''}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="feedback-status">
              ${
                item.review_status === 'pending'
                  ? '<span style="color: var(--warning-color); font-weight: bold;">PENDING</span>'
                  : item.review_status === 'accepted'
                    ? `<span style="color: var(--success-color); font-weight: bold;">ACCEPTED</span><div style="font-size:.8em;color:var(--text-secondary);">by ${item.reviewed_by || ''}</div>`
                    : `<span style="color: var(--error-color); font-weight: bold;">REJECTED</span><div style="font-size:.8em;color:var(--text-secondary);">by ${item.reviewed_by || ''}</div>`
              }
            </div>
            <div class="feedback-actions">
              <button onclick="viewFeedback('${item.id}', '${encodeURIComponent(item.design_prompt || '')}', '${encodeURIComponent(item.feedback_text || '')}', '${encodeURIComponent(item.generated_code || '')}')" class="btn btn-secondary btn-small">üëÅÔ∏è View Feedback</button>
              ${
                item.review_status === 'pending'
                  ? `<button onclick="decideFeedback('${item.id}','accept')" class="btn btn-primary btn-small">‚úÖ Accept & Train</button>
                     <button onclick="confirmRejectFeedback('${item.id}')"  class="btn btn-secondary btn-small">‚ùå Reject</button>`
                  : `<span style="color: var(--text-secondary); font-size:.9em;">${item.review_status === 'accepted' ? '‚úÖ Approved' : '‚ùå Rejected'}</span>`
              }
            </div>
          </div>
        </div>`).join('');

      listEl.innerHTML = `<div><strong>Found ${data.total} items (Page ${data.page}/${data.totalPages})</strong></div>${rows}`;
    } catch (e) {
      statusEl.className = 'status-indicator status-error';
      listEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load feedback: ${e.message}</span>`;
    }
  }

  async function decideFeedback(feedbackId, decision) {
    const row = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
    const acceptBtn = row?.querySelector('button[onclick*="accept"]');
    const rejectBtn = row?.querySelector('button[onclick*="reject"]');
    
    // Disable buttons during request
    if (acceptBtn) acceptBtn.disabled = true;
    if (rejectBtn) rejectBtn.disabled = true;

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-feedback-decide', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          feedback_id: feedbackId, 
          decision, 
          tags: decision === 'accept' ? ['admin-approved'] : null, 
          reason: `Admin ${decision} via console` 
        })
      });
      
      const data = await res.json();
      
      if (!data.ok) {
        const errorMsg = data.code ? `${data.code}: ${data.error}` : (data.error || data.details || `Failed to ${decision} feedback`);
        throw new Error(errorMsg);
      }

      // Update row UI in place (optimistic update)
      if (row) {
        const statusCell = row.querySelector('.feedback-status');
        const actionsCell = row.querySelector('.feedback-actions');
        const newStatus = data.feedback?.review_status || (decision === 'accept' ? 'accepted' : 'rejected');
        const color = newStatus === 'accepted' ? 'var(--success-color)' : 'var(--error-color)';
        const reviewedBy = data.feedback?.reviewed_by || 'admin';

        if (statusCell) {
          statusCell.innerHTML = `
            <span style="color:${color};font-weight:bold;">${newStatus.toUpperCase()}</span>
            <div style="font-size:.8em;color:var(--text-secondary);">by ${reviewedBy}</div>
          `;
        }
        
        if (actionsCell) {
          actionsCell.innerHTML = `<span style="color: var(--text-secondary); font-size:.9em;">${newStatus === 'accepted' ? '‚úÖ Approved' : '‚ùå Rejected'}</span>`;
        }

        // Remove row from pending view after update
        const currentFilter = document.getElementById('feedback-status-filter').value;
        if (currentFilter === 'pending' && newStatus !== 'pending') {
          row.style.transition = 'opacity .3s ease-out';
          row.style.opacity = '0.5';
          setTimeout(() => row.remove(), 300);
        }
      }

      const message = decision === 'accept' 
        ? 'Feedback accepted! Promoted to curated examples and added to training assets.'
        : 'Feedback rejected successfully.';
      showToast(message, 'success');
      
      // Refresh training assets list if we accepted feedback
      if (decision === 'accept') {
        setTimeout(() => loadTrainingAssets(), 500);
      }
      
    } catch (e) {
      // Re-enable buttons on error
      if (acceptBtn) acceptBtn.disabled = false;
      if (rejectBtn) rejectBtn.disabled = false;
      showToast(`Failed to ${decision} feedback: ${e.message}`, 'error');
    }
  }

  function showToast(message, type='info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed; top:20px; right:20px; padding:12px 20px;
      background: ${type==='success' ? 'var(--success-color)' : type==='error' ? 'var(--error-color)' : 'var(--primary)'};
      color:#fff; border-radius:4px; box-shadow:0 4px 12px rgba(0,0,0,.3);
      z-index:10000; font-size:14px; max-width:400px; transition:opacity .3s ease;`;
    toast.innerHTML = message; // Use innerHTML to support <br> tags
    document.body.appendChild(toast);
    setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); }, 3000);
  }

  // ---------------- Feedback Modal ----------------
  let currentModalFeedbackId = null;
  
  function viewFeedback(id, designPrompt, feedbackText, generatedCode) {
    currentModalFeedbackId = id;
    
    // Phase 4.6.1: Use new modal system with scrollable content
    const modalHTML = `
      <div class="feedback-modal-content" style="max-width: 800px; max-height: 70vh;">
        <h3>Feedback Review - ID: ${id}</h3>
        
        <div style="max-height: 60vh; overflow-y: auto; padding: 1rem; background: var(--bg-secondary); border-radius: 5px;">
          <div style="margin-bottom: 1rem;">
            <h4>Design Prompt:</h4>
            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 3px; font-family: monospace;">
              ${decodeURIComponent(designPrompt)}
            </div>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <h4>User Feedback:</h4>
            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 3px;">
              ${decodeURIComponent(feedbackText)}
            </div>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <h4>Generated Code:</h4>
            <pre style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 3px; font-size: 0.8rem; overflow-x: auto;">${decodeURIComponent(generatedCode)}</pre>
          </div>
        </div>
        
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="hideModal()">Close</button>
          <button class="btn btn-success" onclick="decideFeedback('${id}', 'accept'); hideModal();">‚úÖ Accept</button>
          <button class="btn btn-danger" onclick="confirmRejectFeedback('${id}')">‚ùå Reject</button>
        </div>
      </div>
    `;
    
    showModal(modalHTML);
  }
  
  function getCurrentModalFeedbackId() {
    return currentModalFeedbackId;
  }
  
  function confirmRejectFeedback(feedbackId) {
    if (confirm('Are you sure you want to reject this feedback?')) {
      decideFeedback(feedbackId, 'reject');
    }
  }

  // ---------------- Knowledge Test ----------------
  async function runKnowledgeTest() {
    const resultsEl = document.getElementById('knowledge-results');
    const indicatorEl = document.getElementById('knowledge-indicator');
    const prompt = document.getElementById('knowledge-prompt').value;
    const template = document.getElementById('knowledge-template').value;
    
    indicatorEl.className = 'status-indicator status-unknown';
    resultsEl.style.display = 'none';
    
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-knowledge-test', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, template, maxExamples: 5 })
      });
      const data = await res.json();
      
      if (!data.ok) throw new Error(data.error || 'Knowledge test failed');
      
      // Update learning indicator
      const indicatorClass = data.learningIndicator === 'rich' ? 'status-ok' : 
                            data.learningIndicator === 'engaged' ? 'status-warning' : 'status-error';
      indicatorEl.className = `status-indicator ${indicatorClass}`;
      
      // Display results
      const pillClass = data.learningIndicator === 'rich' ? 'learning-rich' : 
                       data.learningIndicator === 'engaged' ? 'learning-engaged' : 'learning-none';
      
      document.getElementById('learning-indicator-display').innerHTML = 
        `<span class="learning-pill ${pillClass}">${data.learningIndicator.toUpperCase()}</span>
         Model: ${data.model}`;
      
      // Examples used
      if (data.used_examples?.length > 0) {
        const examplesHtml = data.used_examples.map(ex => 
          `<tr><td>${ex.id}</td><td>${ex.template || 'general'}</td><td>${(ex.tags || []).join(', ')}</td></tr>`
        ).join('');
        document.getElementById('knowledge-examples').innerHTML = 
          `<h4>Examples Used (${data.used_examples.length})</h4>
           <table class="admin-table">
             <tr><th>ID</th><th>Template</th><th>Tags</th></tr>
             ${examplesHtml}
           </table>`;
      } else {
        document.getElementById('knowledge-examples').innerHTML = '<h4>No examples used</h4>';
      }
      
      // Assets used
      if (data.assets_used?.length > 0) {
        const assetsHtml = data.assets_used.map(asset => 
          `<tr>
             <td>${asset.filename || asset.object_path}</td>
             <td>${asset.source}</td>
             <td>${asset.bytesUsed} bytes</td>
             <td>
               ${asset.object_path.endsWith('.jsonl') 
                 ? `<button onclick="previewJsonl('${encodeURIComponent(asset.object_path)}')" class="btn btn-secondary btn-small">üîé Preview</button>`
                 : ''
               }
             </td>
           </tr>`
        ).join('');
        document.getElementById('knowledge-assets').innerHTML = 
          `<h4>Assets Used (${data.assets_used.length})</h4>
           <table class="admin-table">
             <tr><th>File</th><th>Source</th><th>Bytes Used</th><th>Actions</th></tr>
             ${assetsHtml}
           </table>`;
      } else {
        document.getElementById('knowledge-assets').innerHTML = '<h4>No assets used</h4>';
      }
      
      // Debug log
      document.getElementById('knowledge-log-content').textContent = (data.log || []).join('\n');
      
      resultsEl.style.display = 'block';
      showToast(`Knowledge test complete: ${data.learningIndicator} learning level`, 'success');
      
    } catch (e) {
      indicatorEl.className = 'status-indicator status-error';
      showToast(`Knowledge test failed: ${e.message}`, 'error');
    }
  }

  // ---------------- Training Assets ----------------
  async function loadTrainingAssets() {
    const listEl = document.getElementById('training-assets-list');
    listEl.innerHTML = '<span class="loading-spinner"></span> Loading training assets...';
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-list-training-assets', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Failed to load training assets');

      // Accept either data.assets or legacy data.items
      const rows = data.assets ?? data.items ?? [];
      if (!rows.length) {
        listEl.innerHTML = '<div>No training assets uploaded yet.</div>';
        return;
      }

      listEl.innerHTML = rows.map(a => `
        <div class="asset-row" data-asset-id="${a.id}" style="display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color);padding:10px;border-radius:6px;margin:.5rem 0;">
          <div>
            <div><strong>${a.filename}</strong> <small>(${a.asset_type})</small></div>
            <div style="font-size:.8rem;color:var(--text-secondary);">
              ${Math.round((a.size_bytes||0)/1024)} KB ‚Ä¢ ${new Date(a.created_at).toLocaleString()}
              ${a.tags?.length ? ` ‚Ä¢ Tags: ${a.tags.join(', ')}` : ''}
            </div>
          </div>
          <div class="admin-actions">
            ${a.asset_type === 'jsonl'
              ? `<button class="btn btn-secondary btn-small" onclick="previewJsonl('${encodeURIComponent(a.object_path)}')">üîé Preview</button>`
              : (a.url ? `<a class="btn btn-secondary btn-small" href="${a.url}" target="_blank" rel="noopener">üëÅÔ∏è View</a>` : '')
            }
            <button class="btn btn-secondary btn-small" onclick="deleteTrainingAsset('${a.id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      listEl.innerHTML = `<span style="color: var(--error-color);">‚ùå Failed to load assets: ${e.message}</span>`;
    }
  }

  async function uploadTrainingAsset() {
    const input = document.getElementById('asset-file-input');
    const file = input.files[0];
    if (!file) { alert('Select a file to upload'); return; }

    const allowed = ['.svg','.scad','.jsonl'];
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) { alert(`Invalid file type. Allowed: ${allowed.join(', ')}`); return; }

    const listEl = document.getElementById('training-assets-list');
    listEl.innerHTML = '<span class="loading-spinner"></span> Uploading training asset...';

    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;

      // 1) Create signed upload
      const createRes = await fetch('/.netlify/functions/admin-create-signed-upload', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: file.name,
          contentType: file.type || 'application/octet-stream',
          size: file.size,
          assetType: ext.slice(1), // svg|scad|jsonl
          tags: []
        })
      });
      const createData = await createRes.json();
      if (!createData.ok) throw new Error(createData.error || 'Failed to create signed upload URL');

      // 2) Upload directly to storage
      const upload = await supabaseClient.storage
        .from(createData.bucket)
        .uploadToSignedUrl(createData.object_path, createData.token, file, { contentType: file.type || 'application/octet-stream' });
      if (upload.error) throw new Error(`Upload to storage failed: ${upload.error.message}`);

      // 3) Commit metadata (server validates JSONL sample if needed)
      const commitRes = await fetch('/.netlify/functions/admin-commit-training-asset', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          object_path: createData.object_path,
          assetType: createData.assetType,   // <‚Äî ensure this line exists
          filename: file.name,
          size: file.size,
          contentType: file.type || 'application/octet-stream',
          tags: []
        })
      });
      const commitData = await commitRes.json();
      
      // --- BEGIN PATCH: commitData handling (Upload Training Asset) ---
      if (commitData.ok) {
        const msg = commitData.sampleValidated
          ? `Upload successful! Validated ${commitData.sampleCount} JSONL lines.`
          : 'Asset uploaded successfully!';
        showToast(msg, 'success');
        input.value = '';
        await loadTrainingAssets();
      } else {
        if (commitData.code === 'invalid_jsonl') {
          const where = commitData.lineNumber ? ` on line ${commitData.lineNumber}` : '';
          const snippet = commitData.snippet ? `\nSnippet: ${commitData.snippet}` : '';
          showToast(`JSONL validation failed${where}: ${commitData.error || 'Parse error'}${snippet}`, 'error');
        } else {
          showToast(`Upload failed: ${commitData.error || 'Unknown error'}`, 'error');
        }
      }
      // --- END PATCH ---
    } catch (e) {
      console.error('Upload error:', e);
      const msg = e.message.includes('<br>') ? e.message : `‚ùå Upload failed: ${e.message}`;
      document.getElementById('training-assets-list').innerHTML = `<span style="color: var(--error-color);">${msg}</span>`;
      if (e.message.includes('JSONL validation')) showToast('JSONL file validation failed. Check details.', 'error');
    }
  }

  async function previewJsonl(objectPath) {
    try {
      const session = await supabaseClient.auth.getSession();
      const token = session.data?.session?.access_token;
      const r = await fetch(`/.netlify/functions/admin-jsonl-preview?object_path=${objectPath}&limit=20`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'Preview failed');

      const lines = data.lines || [];
      const html = lines.map(l => 
        l.error 
          ? `Line ${l.lineNumber}: <span style="color: var(--error-color);">ERROR - ${l.error}</span>`
          : `Line ${l.lineNumber}: ${l.keys.join(', ')}`
      ).join('<br>');
      
      // Phase 4.6.1: Use new modal system instead of toast
      const modalHTML = `
        <div class="jsonl-preview-modal">
          <h3>JSONL Preview: ${objectPath}</h3>
          <div class="preview-info">
            <p><strong>Sample Size:</strong> ${data.sampleSizeBytes} bytes</p>
            <p><strong>Lines Preview:</strong> ${lines.length}</p>
          </div>
          <div class="preview-content" style="max-height: 400px; overflow-y: auto; background: var(--bg-secondary); padding: 1rem; border-radius: 5px; font-family: monospace; font-size: 0.9rem;">
            ${html}
          </div>
          <div style="margin-top: 1rem; text-align: right;">
            <button class="btn btn-secondary" onclick="hideModal()">Close</button>
          </div>
        </div>
      `;
      
      showModal(modalHTML);
    } catch (e) {
      showToast(`Preview failed: ${e.message}`, 'error');
    }
  }

  async function deleteTrainingAsset(id) {
    if (!confirm('Delete this training asset?')) return;
    try {
      const token = (await supabaseClient.auth.getSession()).data?.session?.access_token;
      const res = await fetch('/.netlify/functions/admin-delete-training-asset', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Delete failed');
      loadTrainingAssets();
    } catch (e) {
      alert(`Failed to delete asset: ${e.message}`);
    }
  }

  // ---------------- Logout ----------------
  function handleLogout() { window.flexicadAuth.logout(); }
</script>

<!-- Modal Root for Phase 4.6 -->
<div id="modal-root" class="modal-root" hidden>
  <div class="modal-backdrop"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <button class="modal-close" aria-label="Close">√ó</button>
    <div class="modal-content"></div>
  </div>
</div>

<script type="module" src="../js/modals.js"></script>
</body>
</html>