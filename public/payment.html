<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Required - FlexiCAD Designer</title>
    <link rel="stylesheet" href="css/dark-theme.css">
    <style>
        .payment-required {
            max-width: 600px;
            margin: 4rem auto;
            padding: 2rem;
            text-align: center;
        }

        .payment-icon {
            font-size: 4rem;
            color: #f59e0b;
            margin-bottom: 2rem;
        }

        .payment-message {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .payment-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .account-info {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .account-info h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .account-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .promo-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .promo-form {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .promo-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
            text-transform: uppercase;
        }

        .promo-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .promo-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .promo-btn:hover {
            background: var(--primary-hover);
        }

        .promo-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .promo-result {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .promo-success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
        }

        .promo-error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }

        .discount-info {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .promo-section {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .payment-actions {
                flex-direction: column;
                align-items: center;
            }

            .payment-required {
                margin: 2rem auto;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">FlexiCAD Designer</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <main class="payment-required">
        <div class="payment-icon">ðŸ’³</div>

        <h1>Payment Required</h1>

        <div class="payment-message">
            <h2>Your account needs payment to be activated</h2>
            <p>Your FlexiCAD Designer account has been created, but requires payment to access the full platform. Complete your subscription to start creating amazing 3D designs with AI.</p>
        </div>

        <div id="account-info" class="account-info" style="display: none;">
            <h3>Account Information</h3>
            <div class="account-details">
                <p><strong>Email:</strong> <span id="user-email">â€”</span></p>
                <p><strong>Account Status:</strong> <span class="status-unpaid">Unpaid</span></p>
                <p><strong>Plan:</strong> <span id="user-plan">â€”</span></p>
            </div>
        </div>

        <div class="promo-section">
            <h3>Have a Promo Code?</h3>
            <p>Enter your discount code below to save on your subscription</p>
            
            <div class="promo-form">
                <input type="text" 
                       id="promo-code-input" 
                       class="promo-input" 
                       placeholder="Enter promo code (e.g., WELCOME20)"
                       autocomplete="off">
                <button id="apply-promo-btn" class="promo-btn">Apply</button>
            </div>

            <div id="promo-result" class="promo-result" style="display: none;"></div>
            <div id="discount-info" class="discount-info" style="display: none;">
                <strong>ðŸŽ‰ Discount Applied!</strong>
                <div>You'll save <span id="discount-amount"></span> with code "<span id="applied-code"></span>"</div>
            </div>
        </div>

        <div class="payment-actions">
            <button id="complete-payment-btn" class="btn btn-primary">Complete Payment</button>
            <button onclick="logout()" class="btn btn-secondary">Logout</button>
            <a href="login.html" class="btn btn-link">Already paid? Login here</a>
        </div>

        <div style="margin-top: 3rem; color: var(--text-secondary); font-size: 0.9rem;">
            <p>Need help? Contact our support team.</p>
            <p>Your account will remain active for 30 days pending payment completion.</p>
        </div>
    </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/secure-config-loader.js"></script>
    <script src="js/flexicad-auth.js"></script>
    <script>
        // Payment Required Page Logic

        // Initialize Supabase client
        let supabaseClient;
        
        // Global promo code state
        let appliedPromoCode = null;

        async function validatePromoCode(code) {
            try {
                console.log('ðŸŽŸï¸ Validating promo code:', code);

                const response = await fetch('/api/validate-promo-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();
                console.log('ðŸ“‹ Promo validation result:', result);
                
                return result;
            } catch (error) {
                console.error('âŒ Error validating promo code:', error);
                return { valid: false, error: 'Failed to validate promo code' };
            }
        }

        function showPromoResult(result, isSuccess = false) {
            const resultDiv = document.getElementById('promo-result');
            const discountDiv = document.getElementById('discount-info');
            
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.className = `promo-result ${isSuccess ? 'promo-success' : 'promo-error'}`;
                resultDiv.textContent = result;
            }
            
            // Hide discount info if there's an error
            if (!isSuccess && discountDiv) {
                discountDiv.style.display = 'none';
            }
        }

        function showDiscountInfo(promoCode) {
            const discountDiv = document.getElementById('discount-info');
            const discountAmount = document.getElementById('discount-amount');
            const appliedCodeSpan = document.getElementById('applied-code');
            
            if (discountDiv && discountAmount && appliedCodeSpan) {
                discountAmount.textContent = `${promoCode.discount_percent}%`;
                appliedCodeSpan.textContent = promoCode.code;
                discountDiv.style.display = 'block';
            }
            
            // Hide the result message
            const resultDiv = document.getElementById('promo-result');
            if (resultDiv) {
                resultDiv.style.display = 'none';
            }
        }

        async function applyPromoCode() {
            const input = document.getElementById('promo-code-input');
            const button = document.getElementById('apply-promo-btn');
            
            if (!input || !button) return;
            
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                showPromoResult('Please enter a promo code');
                return;
            }
            
            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'Checking...';
            
            try {
                const result = await validatePromoCode(code);
                
                if (result.valid) {
                    appliedPromoCode = result;
                    input.value = result.code;
                    input.disabled = true;
                    button.textContent = 'Applied âœ“';
                    button.style.background = '#10b981';
                    
                    showDiscountInfo(result);
                    console.log('âœ… Promo code applied successfully');
                } else {
                    showPromoResult(result.error || 'Invalid promo code');
                    button.disabled = false;
                    button.textContent = 'Apply';
                }
            } catch (error) {
                console.error('âŒ Error applying promo code:', error);
                showPromoResult('Failed to apply promo code. Please try again.');
                button.disabled = false;
                button.textContent = 'Apply';
            }
        }

        function setupPromoCodeEvents() {
            const input = document.getElementById('promo-code-input');
            const button = document.getElementById('apply-promo-btn');
            const paymentBtn = document.getElementById('complete-payment-btn');
            
            if (button) {
                button.addEventListener('click', applyPromoCode);
            }
            
            if (paymentBtn) {
                paymentBtn.addEventListener('click', handleCompletePayment);
            }
            
            if (input) {
                // Allow applying promo with Enter key
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyPromoCode();
                    }
                });
                
                // Clear results when user starts typing again
                input.addEventListener('input', () => {
                    if (appliedPromoCode) return; // Don't clear if already applied
                    
                    const resultDiv = document.getElementById('promo-result');
                    if (resultDiv) {
                        resultDiv.style.display = 'none';
                    }
                });
            }
        }

        function handleCompletePayment() {
            // Redirect to register page with promo code if applied
            let url = 'register.html';
            
            if (appliedPromoCode) {
                url += `?promo_code=${encodeURIComponent(appliedPromoCode.code)}`;
                console.log('ðŸŽŸï¸ Redirecting to payment with promo code:', appliedPromoCode.code);
            }
            
            window.location.href = url;
        }

        async function logout() {
            console.log('ðŸ”„ Logging out user...');

            // Use the shared Supabase client
            supabaseClient = window.flexicadAuth.getSupabaseClient();
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }

            // Clear session storage
            sessionStorage.clear();

            console.log('âœ… User logged out');

            // Redirect to home
            window.location.href = '/index.html';
        }

        // Check if user is logged in and show their info
        async function checkUserStatus() {
            try {
                await window.flexicadAuth.init();

                if (window.flexicadAuth.user) {
                    console.log('âœ… User is logged in, showing account info');

                    // Show account info section
                    const accountInfo = document.getElementById('account-info');
                    const userEmail = document.getElementById('user-email');
                    const userPlan = document.getElementById('user-plan');

                    if (accountInfo && userEmail) {
                        userEmail.textContent = window.flexicadAuth.user.email;
                        userPlan.textContent = window.flexicadAuth.paymentStatus?.subscription_plan || 'Not set';
                        accountInfo.style.display = 'block';
                    }

                    // If user is actually paid, redirect them to home
                    if (window.flexicadAuth.paymentStatus?.is_paid) {
                        console.log('ðŸŽ‰ User is actually paid, redirecting to home');
                        window.location.href = '/home.html';
                        return;
                    }
                } else {
                    console.log('â„¹ï¸ No user logged in');
                }
            } catch (error) {
                console.error('âŒ Error checking user status:', error);
            }
        }

        // Check URL parameters for specific messages
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');

            if (message) {
                const messageDiv = document.querySelector('.payment-message p');
                if (messageDiv) {
                    switch (message) {
                        case 'login_blocked':
                            messageDiv.textContent = 'Your account requires payment before you can log in. Please complete your subscription to access FlexiCAD Designer.';
                            break;
                        case 'access_denied':
                            messageDiv.textContent = 'Access denied. Your account does not have an active subscription. Please complete payment to continue.';
                            break;
                        case 'payment_incomplete':
                            messageDiv.textContent = 'Your registration was started but payment was not completed. Please finish your subscription to activate your account.';
                            break;
                        default:
                            // Keep default message
                            break;
                    }
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Initializing payment required page...');

            // Check URL parameters first
            checkURLParams();

            // Setup promo code functionality
            setupPromoCodeEvents();

            // Check user status
            await checkUserStatus();
        });
    </script>
</body>
</html>