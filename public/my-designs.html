<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiCAD Designer - My Designs</title>
    <link rel="stylesheet" href="css/dark-theme.css">
</head>
<body>
    <!-- Navigation will be managed by navbar-manager.js -->

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">My Designs</h1>
            <p class="page-subtitle">Manage and organize your saved 3D designs</p>
        </div>

        <!-- Actions Bar -->
        <div class="card">
            <div class="card-actions">
                <a href="ai.html" class="btn btn-primary">
                    ü§ñ Generate Design
                </a>
                <a href="templates.html" class="btn btn-secondary">
                    üìö Browse Templates
                </a>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading your designs...
        </div>

        <!-- Error State -->
        <div id="error" class="alert alert-error hidden">
            <span id="errorMessage">Failed to load designs. Please try refreshing the page.</span>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="card hidden">
            <div class="card-title">No Designs Yet</div>
            <div class="card-description">
                You haven't created any designs yet. Start by using our AI generator or browsing templates.
            </div>
            <div class="card-actions mt-2">
                <a href="ai.html" class="btn btn-primary">ü§ñ Generate Design</a>
                <a href="templates.html" class="btn btn-secondary">üìö Browse Templates</a>
            </div>
        </div>

        <!-- Designs Grid -->
        <div id="designsGrid" class="card-grid hidden"></div>
    </div>

    <!-- Design View Modal -->
    <div id="designModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Design Details</h2>
                <button class="modal-close" onclick="closeModal('designModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card-description mb-3" id="modalPrompt"></div>
                
                <div class="code-container">
                    <div class="code-header">
                        <span id="modalFileName">design.scad</span>
                        <div>
                            <button class="btn btn-small btn-secondary" onclick="copyModalCode()">Copy Code</button>
                            <button class="btn btn-small btn-secondary" onclick="downloadModalCode()">Download</button>
                        </div>
                    </div>
                    <pre class="code-block" id="modalCode"></pre>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="deleteCurrentDesign()">üóëÔ∏è Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('designModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Delete</h2>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteDesignName"></span>"?</p>
                <p><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/secure-config-loader.js"></script>
    <script src="js/flexicad-auth.js"></script>
    <script src="js/navbar-manager.js"></script>
    <script src="js/stl-exporter.js"></script>
    <script>
        // For My Designs page, we need both session check AND Supabase client for database operations
        let designs = [];
        let currentDesign = null;
        let designToDelete = null;
        let supabaseClient;

        // Check authentication and load designs
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user has paid access
            const hasAccess = await window.flexicadAuth.requireAuth();
            
            if (hasAccess) {
                console.log('User has paid access to My Designs');
                
                // Display user info
                const userInfo = document.querySelector('.user-info');
                if (window.flexicadAuth.user && userInfo) {
                    userInfo.textContent = window.flexicadAuth.user.email || 'User';
                }
                
                // Initialize designs functionality
                await initDesigns();
            }
        });

        function handleLogout() {
            window.flexicadAuth.logout();
        }

        async function initDesigns() {
            // Use the global shared Supabase client
            supabaseClient = window.getSharedSupabaseClient();
            
            if (!supabaseClient) {
                console.error('Failed to get shared Supabase client. Trying to initialize...');
                await window.flexicadAuth.init();
                supabaseClient = window.getSharedSupabaseClient();
                
                if (!supabaseClient) {
                    console.error('Still failed to get Supabase client');
                    showError('Authentication system not properly initialized');
                    return;
                }
            }

            await loadDesigns();
        }

        async function loadDesigns() {
            showLoading();
            hideError();
            hideEmpty();
            hideDesigns();
            
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    throw new Error('Authentication required');
                }

                // Load designs from Supabase ai_designs table
                const { data: designsData, error } = await supabaseClient
                    .from('ai_designs')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                designs = designsData || [];
                
                hideLoading();
                
                if (designs.length === 0) {
                    showEmpty();
                } else {
                    displayDesigns();
                    showDesigns();
                }
                
            } catch (error) {
                console.error('Error loading designs:', error);
                hideLoading();
                showError(error.message);
            }
        }

        function displayDesigns() {
            hideLoading();
            hideError();
            
            if (designs.length === 0) {
                showEmpty();
                return;
            }
            
            const grid = document.getElementById('designsGrid');
            grid.innerHTML = designs.map(design => {
                const date = new Date(design.created_at).toLocaleDateString();
                const codePreview = design.code.substring(0, 100) + '...';
                
                return `
                    <div class="card">
                        <div class="card-title">${escapeHtml(design.name)}</div>
                        <div class="card-description">
                            ${design.prompt ? `<strong>Prompt:</strong> ${escapeHtml(design.prompt.substring(0, 80))}${design.prompt.length > 80 ? '...' : ''}` : 'Custom design'}
                        </div>
                        <div class="card-meta">
                            <span>Created: ${date}</span>
                        </div>
                        <div class="code-container" style="margin-top: 1rem;">
                            <div class="code-header">
                                <span>Preview</span>
                            </div>
                            <pre class="code-block" style="font-size: 12px; max-height: 80px; overflow: hidden;">${escapeHtml(codePreview)}</pre>
                        </div>
                        <div class="card-actions mt-3">
                            <button class="btn btn-secondary btn-small" onclick="viewDesign('${design.id}')">
                                üëÅÔ∏è View
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="copyDesign('${design.id}')">
                                üìã Copy
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="downloadDesign('${design.id}')">
                                ‚¨áÔ∏è Download
                            </button>
                            <button class="btn btn-danger btn-small" onclick="showDeleteConfirmation('${design.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            showDesigns();
        }

        function viewDesign(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            currentDesign = design;
            
            document.getElementById('modalTitle').textContent = design.name;
            document.getElementById('modalPrompt').textContent = design.prompt || 'No prompt provided';
            document.getElementById('modalFileName').textContent = `${design.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            document.getElementById('modalCode').textContent = design.code;
            
            showModal('designModal');
        }

        async function copyDesign(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            try {
                await navigator.clipboard.writeText(design.code);
                
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Failed to copy code:', error);
                alert('Failed to copy code to clipboard');
            }
        }

        function downloadDesign(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            const fileName = `${design.name.toLowerCase().replace(/\s+/g, '-')}.scad`;
            const blob = new Blob([design.code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showDeleteConfirmation(designId) {
            const design = designs.find(d => d.id === designId);
            if (!design) return;
            
            designToDelete = design;
            document.getElementById('deleteDesignName').textContent = design.name;
            showModal('deleteModal');
        }

        async function confirmDelete() {
            if (!designToDelete) return;
            
            try {
                const { error } = await supabaseClient
                    .from('ai_designs')
                    .delete()
                    .eq('id', designToDelete.id);

                if (error) {
                    throw error;
                }
                
                // Remove from local array
                designs = designs.filter(d => d.id !== designToDelete.id);
                displayDesigns();
                
                closeModal('deleteModal');
                designToDelete = null;
                
            } catch (error) {
                console.error('Error deleting design:', error);
                alert(`Failed to delete design: ${error.message}`);
            }
        }

        function deleteCurrentDesign() {
            if (currentDesign) {
                closeModal('designModal');
                showDeleteConfirmation(currentDesign.id);
            }
        }

        function copyModalCode() {
            if (!currentDesign) return;
            
            navigator.clipboard.writeText(currentDesign.code).then(() => {
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code to clipboard');
            });
        }

        function downloadModalCode() {
            if (currentDesign) {
                downloadDesign(currentDesign.id);
            }
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('designsGrid').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            hideError();
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
            hideLoading();
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function showEmpty() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('designsGrid').classList.add('hidden');
        }

        function hideEmpty() {
            document.getElementById('emptyState').classList.add('hidden');
        }

        function showDesigns() {
            document.getElementById('designsGrid').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function hideDesigns() {
            document.getElementById('designsGrid').classList.add('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'designModal') {
                currentDesign = null;
            }
            if (modalId === 'deleteModal') {
                designToDelete = null;
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Listen for auth state changes using flexicadAuth
        if (typeof window.flexicadAuth !== 'undefined') {
            // Set up auth state monitoring
            const checkAuthPeriodically = () => {
                setInterval(async () => {
                    const user = await window.flexicadAuth.getUser();
                    if (!user) {
                        window.location.href = 'login.html';
                    }
                }, 5000); // Check every 5 seconds
            };
            
            checkAuthPeriodically();
        }
    </script>
</body>
</html>